<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Auto.js结合 Mimtproxy爬取抖音店铺数据</title>
    <url>/2022/03/20/Autojs/</url>
    <content><![CDATA[<h3 id="Auto-js结合-Mimtproxy爬取抖音店铺数据"><a href="#Auto-js结合-Mimtproxy爬取抖音店铺数据" class="headerlink" title="Auto.js结合 Mimtproxy爬取抖音店铺数据"></a>Auto.js结合 Mimtproxy爬取抖音店铺数据</h3><h4 id="软件的安装"><a href="#软件的安装" class="headerlink" title="软件的安装"></a>软件的安装</h4><h5 id="1-Auto-js"><a href="#1-Auto-js" class="headerlink" title="1.Auto.js"></a>1.Auto.js</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Auto.js是Android上支持Node.js的JavaScript自动化和编程软件。</span><br><span class="line">由于auto.js被大量用于黑产目前作者，不支持，不维护免费版。只有维护付费版Auto.js Pro。</span><br></pre></td></tr></table></figure>
<p>1.模拟器安装是AutoJs4.1.0.apk免费版<br>auto.js 安装时开启无障碍服务<br><img src="/2022/03/20/Autojs/img.png" alt="img.png"><br>可以设置 按音量向上建停止代码，防止写无限循环推不出来<br>2.电脑端安装vscode<br>安装auto.js插件，输入如hyb1996，将两个插件进行安装<br><img src="/2022/03/20/Autojs/img_3.png" alt="安装插件"></p>
<h5 id="2-mitmproxy-安装"><a href="#2-mitmproxy-安装" class="headerlink" title="2.mitmproxy 安装"></a>2.mitmproxy 安装</h5><p>mitmproxy电脑环境安装 参考崔庆才的博客,<a href="https://cuiqingcai.com/5391.html" target="_blank" rel="noopener">mitmproxy安装</a><br>逍遥模拟器手机安装证书 </p>
<ol>
<li>电脑运行 mitmdump -p 8999  (端口号随意，不要冲突即可)</li>
<li>查看电脑ip Windows(ipconfig),Liunx(ifconfig)</li>
<li>电脑手机在同一局域网内，手机Wifi设置代理 <img src="/2022/03/20/Autojs/img_1.png" alt="设置代理"></li>
<li>在浏览器输入mitm.it，下载证书<img src="/2022/03/20/Autojs/img_2.png" alt="下载证书"></li>
<li>安装证书</li>
<li>当安装证书还是不行，抓不到数据需要把证书安装到跟目录下<br> 模拟器安装wifiadb(一个adb可以连接的软件)<br> <img src="/2022/03/20/Autojs/img_0.jpg" alt="参考"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb connect 192.168.31.216</span><br><span class="line">adb shell</span><br><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added</span><br><span class="line">mount -o rw,remount &#x2F;system (安卓7，模拟器是安卓7，安卓8不一样mount -o remount,rw &#x2F;)</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h4><h5 id="1-VScode-编写"><a href="#1-VScode-编写" class="headerlink" title="1. VScode 编写"></a>1. VScode 编写</h5><p>语法可参考 <a href="https://pro.autojs.org/docs/#/zh-cn/?id=%e7%bb%bc%e8%bf%b0" target="_blank" rel="noopener">官网网址</a><br>视频教学可以参考<a href="https://www.bilibili.com/video/BV1pQ4y1R7Us?p=1" target="_blank" rel="noopener">Auto.js从入门到精通</a></p>
<p>自动化代码 demo.js (不同手机，代码可能不适用)<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_shop</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;className(<span class="string">"androidx.recyclerview.widget.RecyclerView"</span>).scrollable(<span class="literal">true</span>).depth(<span class="number">15</span>).findOne().children().forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> target = child.findOne(className(<span class="string">"android.widget.FrameLayout"</span>).depth(<span class="number">22</span>));</span><br><span class="line">        click(target.bounds().centerX(),target.bounds().centerY())</span><br><span class="line">        sleep(<span class="number">3000</span>) </span><br><span class="line">        click_text(<span class="string">'进店'</span>);</span><br><span class="line">        sleep(<span class="number">3000</span>)</span><br><span class="line">        click_text(<span class="string">'商品'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"出现错误"</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">click_text</span>(<span class="params">str1</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 找到文字点击</span></span><br><span class="line">    text(str1).findOne()  </span><br><span class="line">    <span class="built_in">console</span>.log(str1)</span><br><span class="line">    click(str1)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">swipe_down</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 向下滑</span></span><br><span class="line">    <span class="keyword">var</span> i =<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (i)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i)</span><br><span class="line">        <span class="keyword">var</span> finish = id(<span class="string">"ih6"</span>).exists()</span><br><span class="line">        <span class="keyword">if</span> (finish) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        swipe(device.width / <span class="number">2</span>, <span class="number">1000</span>, device.width / <span class="number">2</span>, <span class="number">50</span>, <span class="number">2000</span>);</span><br><span class="line">        i += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">closeApp</span>(<span class="params">packagename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sh = <span class="keyword">new</span> Shell(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//注册一个对象运用shell命令，true(真) 以root权限运行代码，默认为falae假</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"am force-stop"</span>+<span class="string">" "</span>+packagename)</span><br><span class="line">    sh.exec(<span class="string">"am force-stop"</span>+<span class="string">" "</span>+packagename);<span class="comment">//执行代码运行中属于异步运行</span></span><br><span class="line">    <span class="comment">//上面值com.android.browser是浏览器的包名。自行修改成想停止软件的包名</span></span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//给点延迟让前面的运行命令，一会软件就会关闭</span></span><br><span class="line">    sh.exit;</span><br><span class="line">    <span class="comment">//退出Shell命令，正在执行的命令会被强制退出。所以上面加延迟</span></span><br><span class="line">    <span class="comment">// console.log("抖音");</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">closeApp(<span class="string">"com.ss.android.ugc.aweme"</span>) <span class="comment">//关闭抖音</span></span><br><span class="line">sleep(<span class="number">1500</span>)</span><br><span class="line">home();</span><br><span class="line">sleep(<span class="number">1500</span>);</span><br><span class="line"><span class="comment">// click('抖音');</span></span><br><span class="line">launchApp(<span class="string">"抖音"</span>); <span class="comment">// 打开抖音</span></span><br><span class="line">sleep(<span class="number">5000</span>);</span><br><span class="line">click(<span class="string">"以后再说"</span>); <span class="comment">// app提示升级</span></span><br><span class="line">click(<span class="string">"我知道了"</span>); <span class="comment">// 青少年模式</span></span><br><span class="line">click_text(<span class="string">'我'</span>);  <span class="comment">// 点击我</span></span><br><span class="line">sleep(<span class="number">1500</span>);</span><br><span class="line">click_text(<span class="string">'关注'</span>); <span class="comment">// 点击关注</span></span><br><span class="line">sleep(<span class="number">2000</span>)</span><br><span class="line">click_text(<span class="string">"babycare官方旗舰店"</span>) <span class="comment">// 点击babycare官方旗舰店</span></span><br><span class="line">sleep(<span class="number">2000</span>);</span><br><span class="line">click_text(<span class="string">"店铺商品"</span>)</span><br><span class="line">sleep(<span class="number">2000</span>);</span><br><span class="line">click_text(<span class="string">"商品"</span>)</span><br><span class="line">sleep(<span class="number">2000</span>);</span><br><span class="line">swipe_down() <span class="comment">// 下滑</span></span><br><span class="line">closeApp(<span class="string">"com.ss.android.ugc.aweme"</span>)</span><br><span class="line">toast(<span class="string">'hello world!'</span>)</span><br></pre></td></tr></table></figure></p>
<h5 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h5><p>mt.py 将带有aweme/v1/store/product/list链接的数据保存到redis<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">REDIS_HOST = <span class="string">"REDIS_HOST"</span></span><br><span class="line">REDIS_PORT = <span class="number">63791</span></span><br><span class="line">REDIS_ENCODING = <span class="string">'utf-8'</span></span><br><span class="line">red = Redis(host=REDIS_HOST, port=REDIS_PORT, password=<span class="string">"password"</span>, db=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span><span class="params">(flow)</span>:</span></span><br><span class="line">    response_data = flow.response</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'aweme/v1/store/product/list'</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        json_data = json.loads(response_data.text)</span><br><span class="line">        print(json_data)</span><br><span class="line">        red.rpush(<span class="string">'dy:items'</span>, json.dumps(json_data))</span><br></pre></td></tr></table></figure></p>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><ol>
<li>开启auto.js服务 vscode Ctrl+shift+p  点击 Auto.js:Start Server<br> 可能会出现问题:9317端口是未打开的<br> 防火墙-&gt;高级设置-&gt;入站规则-&gt;新建规则-&gt;规则类型：TCP协议，9317端口，然后下一步，下一步，名称自定义</li>
<li>开启mitmproxy  mitmdump -s mt.py -p 8999 </li>
<li>手机WIFI设置代理 (如果前面做了可以省略)</li>
<li>auto.js APP连接电脑<br><img src="/2022/03/20/Autojs/img_5.png" alt="连接电脑.png"><br>5.运行auto.js任务  vscode Ctrl+shift+p  点击 Auto.js:Start Run<br><img src="/2022/03/20/Autojs/img_7.png" alt="运行效果"></li>
</ol>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><p>vscode Ctrl+shift+p  点击 Auto.js:Save On Device 代码就安装到auto.js App中<br>在App 中demo.js设置定时任务 如图<img src="/2022/03/20/Autojs/img_9.png" alt="img_9.png"></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Android逆向之某东到家djencrypt</title>
    <url>/2022/03/31/JDDJ/</url>
    <content><![CDATA[<h4 id="抓包-charles-SagerNet"><a href="#抓包-charles-SagerNet" class="headerlink" title="抓包 charles + SagerNet"></a>抓包 charles + SagerNet</h4><p><img src="/2022/03/31/JDDJ/1.png" alt="抓包"></p>
<h4 id="jadx-静态分析"><a href="#jadx-静态分析" class="headerlink" title="jadx 静态分析"></a>jadx 静态分析</h4><p>搜索 “djencrypt”  很幸运就一个结果</p>
<p><img src="/2022/03/31/JDDJ/2.png" alt="jadx搜索"></p>
<p>进去跟踪函数</p>
<p><img src="/2022/03/31/JDDJ/3.png" alt="jadx搜索"><br><img src="/2022/03/31/JDDJ/4.png" alt="jadx搜索"><br><img src="/2022/03/31/JDDJ/5.png" alt="jadx搜索"><br><img src="/2022/03/31/JDDJ/6.png" alt="jadx搜索"></p>
<p>可以看到djencrypt  猜想是 先aes加密在base64 加密下</p>
<h4 id="打开-逆向之友-https-gchq-github-io-CyberChef"><a href="#打开-逆向之友-https-gchq-github-io-CyberChef" class="headerlink" title="打开 逆向之友 https://gchq.github.io/CyberChef/"></a>打开 逆向之友 <a href="https://gchq.github.io/CyberChef/" target="_blank" rel="noopener">https://gchq.github.io/CyberChef/</a></h4><p>CyberChef 解密</p>
<p><img src="/2022/03/31/JDDJ/img.png" alt="7.png"></p>
<h4 id="frida-hook"><a href="#frida-hook" class="headerlink" title="frida hook"></a>frida hook</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_djencrypt</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		Java.use(<span class="string">"com.jd.jdsdk.security.AesCbcCrypto"</span>).encrypt.overload(<span class="string">'java.lang.String'</span>, <span class="string">'java.lang.String'</span>, <span class="string">'[B'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str1,str2,b1</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"str1=&gt;"</span>,str1,<span class="string">"&lt;=="</span>);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"str2=&gt;"</span>, str2);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"b1=&gt;"</span>, b1)</span><br><span class="line">			<span class="keyword">var</span> result = <span class="keyword">this</span>.encrypt(str1, str2, b1);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"result=&gt;"</span>, result);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hook结果和前面的CyberChef类似，所以我们前面的猜想是正确的</p>
<p><img src="/2022/03/31/JDDJ/7.png" alt="frida hook.png"></p>
<p>但是我们发现传入的参数还有个signKeyV1，继续分析</p>
<p>利用jadx 搜索可知 signKeyV1 是由k2 函数加密的，k2 是native函数，应该在jdpdj相关的so中</p>
<p><img src="/2022/03/31/JDDJ/8.png" alt="jadx"><br><img src="/2022/03/31/JDDJ/9.png" alt="jadx"></p>
<h4 id="ida-分析-libjdpdj-so"><a href="#ida-分析-libjdpdj-so" class="headerlink" title="ida 分析 libjdpdj.so"></a>ida 分析 libjdpdj.so</h4><p>搜索jin,定位到k2</p>
<p><img src="/2022/03/31/JDDJ/10.png" alt="ida"><br><img src="/2022/03/31/JDDJ/11.png" alt="ida"></p>
<p>进入g_k2 搜索发现 hmac_sha256</p>
<p><img src="/2022/03/31/JDDJ/12.png" alt="ida"><br><img src="/2022/03/31/JDDJ/13.png" alt="ida"><br>这里的符号都没去掉，init update final 函数都能看到，这里应该是标准的算法</p>
<h4 id="frida-hook-native"><a href="#frida-hook-native" class="headerlink" title="frida hook native"></a>frida hook native</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookSo1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hmac_sha256 = Module.findExportByName(<span class="string">'libjdpdj.so'</span>, <span class="string">'hmac_sha256'</span>)</span><br><span class="line">    <span class="keyword">var</span> HMAC_CTX_init = Module.findExportByName(<span class="string">'libjdpdj.so'</span>, <span class="string">'HMAC_CTX_init'</span>)</span><br><span class="line">    <span class="keyword">var</span> HMAC_Update = Module.findExportByName(<span class="string">'libjdpdj.so'</span>, <span class="string">'HMAC_Update'</span>)</span><br><span class="line">    <span class="keyword">var</span> HMAC_Init_ex = Module.findExportByName(<span class="string">'libjdpdj.so'</span>, <span class="string">'HMAC_Init_ex'</span>)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(hmac_sha256, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'hmac_sha256 参数 1: '</span>, hexdump(args[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'hmac_sha256 参数 2: '</span>, hexdump(args[<span class="number">1</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'hmac_sha256 参数 3: '</span>, hexdump(args[<span class="number">2</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'hmac_sha256 参数 4: '</span>, hexdump(args[<span class="number">3</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retValue</span>) </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(HMAC_CTX_init, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_CTX_init 参数 1: '</span>, hexdump(args[<span class="number">0</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retValue</span>) </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(HMAC_Update, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Update 参数 1: '</span>, hexdump(args[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Update 参数 2: '</span>, hexdump(args[<span class="number">1</span>], &#123;<span class="attr">length</span>: <span class="number">1200</span>&#125;));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Update 参数 3: '</span>, hexdump(args[<span class="number">2</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retValue</span>) </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(HMAC_Init_ex, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Init_ex 参数 1: '</span>, hexdump(args[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Init_ex 参数 2: '</span>, hexdump(args[<span class="number">1</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Init_ex 参数 3: '</span>, hexdump(args[<span class="number">2</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Init_ex 参数 4: '</span>, hexdump(args[<span class="number">3</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'HMAC_Init_ex 参数 5: '</span>, hexdump(args[<span class="number">4</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retValue</span>) </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MAC_Init_ex so 函数的参数二，长度 32 猜测是 hamc key<br><img src="/2022/03/31/JDDJ/14.png" alt="ida"></p>
<p>AES python<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AESCrypt</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    AES/CBC/PKCS5Padding 加密</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key, iv)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        使用密钥,加密模式进行初始化</span></span><br><span class="line"><span class="string">        :param key:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(key) != <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'密钥长度非16位!!!'</span>)</span><br><span class="line"></span><br><span class="line">        self.key = str.encode(key)</span><br><span class="line">        self.iv = str.encode(iv)</span><br><span class="line">        self.MODE = AES.MODE_CBC</span><br><span class="line">        self.block_size = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 填充函数</span></span><br><span class="line">        <span class="comment"># self.padding = lambda data: data + (self.block_size - len(data) % self.block_size) * chr(self.block_size - len(data) % self.block_size)</span></span><br><span class="line">        <span class="comment"># 此处为一坑,需要现将data转换为byte再来做填充，否则中文特殊字符等会报错</span></span><br><span class="line">        self.padding = <span class="keyword">lambda</span> data: data + (self.block_size - len(data.encode(<span class="string">'utf-8'</span>)) % self.block_size) * chr(</span><br><span class="line">            self.block_size - len(data.encode(<span class="string">'utf-8'</span>)) % self.block_size)</span><br><span class="line">        <span class="comment"># 截断函数</span></span><br><span class="line">        self.unpadding = <span class="keyword">lambda</span> data: data[:-ord(data[<span class="number">-1</span>])]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes_encrypt</span><span class="params">(self, plaintext)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        加密</span></span><br><span class="line"><span class="string">        :param plaintext: 明文</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 填充16位</span></span><br><span class="line">            padding_text = self.padding(plaintext).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">            <span class="comment"># 初始化加密器</span></span><br><span class="line">            cryptor = AES.new(self.key, self.MODE, self.iv)</span><br><span class="line">            <span class="comment"># 进行AES加密</span></span><br><span class="line">            encrypt_aes = cryptor.encrypt(padding_text)</span><br><span class="line">            <span class="comment"># 进行BASE64转码</span></span><br><span class="line">            encrypt_text = (base64.b64encode(encrypt_aes)).decode()</span><br><span class="line">            <span class="keyword">return</span> encrypt_text</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.exception(e)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span><span class="params">(self, ciphertext)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        解密</span></span><br><span class="line"><span class="string">        :param ciphertext: 密文</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 密文必须是16byte的整数倍</span></span><br><span class="line">            <span class="comment"># if len(ciphertext) % 16 != 0:</span></span><br><span class="line">            <span class="comment">#     raise binascii.Error('密文错误!')</span></span><br><span class="line">            cryptor = AES.new(self.key, self.MODE, self.iv)</span><br><span class="line">            <span class="comment"># 进行BASE64转码</span></span><br><span class="line">            plain_base64 = base64.b64decode(ciphertext)</span><br><span class="line">            <span class="comment"># 进行ASE解密</span></span><br><span class="line">            decrypt_text = cryptor.decrypt(plain_base64)</span><br><span class="line">            <span class="comment"># 截取</span></span><br><span class="line">            plain_text = self.unpadding(decrypt_text.decode(<span class="string">"utf-8"</span>))</span><br><span class="line">            <span class="keyword">return</span> plain_text</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">'解密失败,请检查密钥是否正确!'</span>)</span><br><span class="line">            logging.exception(e)</span><br><span class="line">        <span class="keyword">except</span> binascii.Error <span class="keyword">as</span> e:</span><br><span class="line">            logging.exception(e)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.exception(e)</span><br></pre></td></tr></table></figure></p>
<p>python hmac_sha256<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hmac_sha256_encrypt</span><span class="params">(self, key, data)</span>:</span></span><br><span class="line">    _key = key.encode(<span class="string">'utf8'</span>)</span><br><span class="line">    _data = data.encode(<span class="string">'utf8'</span>)</span><br><span class="line">    encrypt_data = hmac.new(_key, _data, digestmod=sha256).hexdigest()</span><br><span class="line">    <span class="comment"># print(encrypt_data)</span></span><br><span class="line">    <span class="keyword">return</span> encrypt_data</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>哈希算法</title>
    <url>/2022/04/05/MD5/</url>
    <content><![CDATA[<h3 id="MD5介绍"><a href="#MD5介绍" class="headerlink" title="MD5介绍"></a>MD5介绍</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MD5信息摘要算法（英语：MD5 Message-Digest Algorithm），一种被广泛使用的密码散列函数，可以产生出一个128位（16字节）的散列值（hash value），用于确保信息传输完整一致。</span><br></pre></td></tr></table></figure>
<h4 id="手算MD5"><a href="#手算MD5" class="headerlink" title="手算MD5"></a>手算MD5</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输入：123456</span><br><span class="line">输出：e10adc3949ba59abbe56e057f20f883e</span><br></pre></td></tr></table></figure>
<p>流程图<br><img src="/2022/04/05/MD5/1.png" alt="流程图"></p>
<p>1.附加填充<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        1   2   3   4   5   6</span><br><span class="line">ascii	31	32	33	34	35	36   48bit</span><br><span class="line"></span><br><span class="line">使得其比特长度除以512余448</span><br><span class="line">填充    31 32 33 34 35 36 80 00 ... 00 </span><br><span class="line">填充长度  512倍数   现在 48bit  填充 400bit (最少填充  8-512)</span><br><span class="line"></span><br><span class="line">留的那64比特长度，用于填充长度信息，长度单位为比特</span><br><span class="line">30 00 00 00 00 00 00 00 00</span><br><span class="line">填充    31 32 33 34 35 36 80 00 ... 00 30 00 00 00 00 00 00 00 00</span><br><span class="line"></span><br><span class="line">M1  	31  32  33  34</span><br><span class="line">M2 		35  36	80	00</span><br><span class="line">M3-M14	00  00  00  00</span><br><span class="line">M15     30	00	00	00</span><br><span class="line">M16		00	00	00	00</span><br></pre></td></tr></table></figure><br>2.初始化链接变量<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 初始化魔数</span><br><span class="line">A 	67452301</span><br><span class="line">B   efcdab89</span><br><span class="line">C   98badcfe</span><br><span class="line">D   10325476</span><br></pre></td></tr></table></figure><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">K = [<span class="number">0xd76aa478</span>, <span class="number">0xe8c7b756</span>, <span class="number">0x242070db</span>, <span class="number">0xc1bdceee</span>, <span class="number">0xf57c0faf</span>,</span><br><span class="line">      <span class="number">0x4787c62a</span>, <span class="number">0xa8304613</span>, <span class="number">0xfd469501</span>, <span class="number">0x698098d8</span>, <span class="number">0x8b44f7af</span>,</span><br><span class="line">      <span class="number">0xffff5bb1</span>, <span class="number">0x895cd7be</span>, <span class="number">0x6b901122</span>, <span class="number">0xfd987193</span>, <span class="number">0xa679438e</span>,</span><br><span class="line">      <span class="number">0x49b40821</span>, <span class="number">0xf61e2562</span>, <span class="number">0xc040b340</span>, <span class="number">0x265e5a51</span>, <span class="number">0xe9b6c7aa</span>,</span><br><span class="line">      <span class="number">0xd62f105d</span>, <span class="number">0x2441453</span>, <span class="number">0xd8a1e681</span>, <span class="number">0xe7d3fbc8</span>, <span class="number">0x21e1cde6</span>,</span><br><span class="line">      <span class="number">0xc33707d6</span>, <span class="number">0xf4d50d87</span>, <span class="number">0x455a14ed</span>, <span class="number">0xa9e3e905</span>, <span class="number">0xfcefa3f8</span>,</span><br><span class="line">      <span class="number">0x676f02d9</span>, <span class="number">0x8d2a4c8a</span>, <span class="number">0xfffa3942</span>, <span class="number">0x8771f681</span>, <span class="number">0x6d9d6122</span>,</span><br><span class="line">      <span class="number">0xfde5380c</span>, <span class="number">0xa4beea44</span>, <span class="number">0x4bdecfa9</span>, <span class="number">0xf6bb4b60</span>, <span class="number">0xbebfbc70</span>,</span><br><span class="line">      <span class="number">0x289b7ec6</span>, <span class="number">0xeaa127fa</span>, <span class="number">0xd4ef3085</span>, <span class="number">0x4881d05</span>, <span class="number">0xd9d4d039</span>,</span><br><span class="line">      <span class="number">0xe6db99e5</span>, <span class="number">0x1fa27cf8</span>, <span class="number">0xc4ac5665</span>, <span class="number">0xf4292244</span>, <span class="number">0x432aff97</span>,</span><br><span class="line">      <span class="number">0xab9423a7</span>, <span class="number">0xfc93a039</span>, <span class="number">0x655b59c3</span>, <span class="number">0x8f0ccc92</span>, <span class="number">0xffeff47d</span>,</span><br><span class="line">      <span class="number">0x85845dd1</span>, <span class="number">0x6fa87e4f</span>, <span class="number">0xfe2ce6e0</span>, <span class="number">0xa3014314</span>, <span class="number">0x4e0811a1</span>,</span><br><span class="line">      <span class="number">0xf7537e82</span>, <span class="number">0xbd3af235</span>, <span class="number">0x2ad7d2bb</span>, <span class="number">0xeb86d391</span>]</span><br></pre></td></tr></table></figure><br><img src="/2022/04/05/MD5/md5core.jpg" alt="md5core"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">图中的F函数并不是一个函数，而是由四个函数组成 64轮  4步</span><br><span class="line">1-16	F1  F(X,Y,Z) &#x3D; (X&amp;Y)|((~X)&amp;Z)       If X then Y else Z </span><br><span class="line">17-32	F2	G(X,Y,Z) &#x3D; (X&amp;Z)|(Y&amp;(~Z))		If Z then X else Y</span><br><span class="line">33-48	F3	H(X,Y,Z) &#x3D; X^Y^Z 					If X&#x3D;Y then Z else ~Z</span><br><span class="line">49-64	F4	I(X,Y,Z) &#x3D; Y^(X|(~Z))</span><br></pre></td></tr></table></figure></p>
<p>手算 123456 md5 第一轮<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A1  10325476</span><br><span class="line">B1	?</span><br><span class="line">C1	efcdab89</span><br><span class="line">D1	98badcfe</span><br><span class="line"></span><br><span class="line">B1 &#x3D; A + F(B,C,D)</span><br><span class="line">B   1110	1111	1100	1101	1010	1011	1000	1001</span><br><span class="line">C	1001	1000	1011	1010	1101	1100	1111	1110</span><br><span class="line">D	0001	0000	0011	0010	0101	0100	0111	0110</span><br><span class="line">F1	1001	1000	1011	1010	1101	1100	1111	1110</span><br><span class="line">	9		8		b 		a 		d 		c 		f 		e</span><br><span class="line">A &#x3D;  10325476</span><br><span class="line">F1 &#x3D;  98badcfe</span><br><span class="line">AF1 &#x3D; A + F1  &#x3D; ffffffff</span><br><span class="line">M1 &#x3D; 34333231</span><br><span class="line">AFM1 &#x3D; AF1 + M1 &#x3D; 134333230</span><br><span class="line">K1 &#x3D; K1</span><br><span class="line">AFM1 &#x3D; AFM1 + K1	&#x3D; 20b9dd6a8	</span><br><span class="line">取余结果	0b9dd6a8</span><br><span class="line">			0000 1011 1001 1101 1101 0110 1010 1000</span><br><span class="line">循环左移7位 	1100 1110 1110 1011 0101 0100 0000 0101	 	</span><br><span class="line">AFM1_MOVE &#x3D; ceeb5404</span><br><span class="line">B_old &#x3D; efcdab89</span><br><span class="line">B1 &#x3D; AFM1_MOVE + B_old &#x3D; 1bebbff8e</span><br><span class="line"></span><br><span class="line">(循环左移 没有规则规则随机  k1-k64  2^32 * |sinX|)</span><br></pre></td></tr></table></figure></p>
<h4 id="每种哈希函数的特征"><a href="#每种哈希函数的特征" class="headerlink" title="每种哈希函数的特征"></a>每种哈希函数的特征</h4><h5 id="1-MD5"><a href="#1-MD5" class="headerlink" title="1.MD5"></a>1.MD5</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">初始化魔数：</span><br><span class="line">A &#x3D; 0x67452301;</span><br><span class="line">B &#x3D; 0xEFCDAB89;</span><br><span class="line">C &#x3D; 0x98BADCFE;</span><br><span class="line">D &#x3D; 0x10325476;</span><br><span class="line"></span><br><span class="line">K表</span><br><span class="line">K1 &#x3D; 0xd76aa478</span><br><span class="line">K2 &#x3D; 0xe8c7b756</span><br><span class="line">K3 &#x3D; 0x242070db</span><br><span class="line">K表来自sin函数</span><br><span class="line"></span><br><span class="line">输出长度16个字节，或者说32个十六进制数，有时候输出16个十六进制数。</span><br></pre></td></tr></table></figure>
<h5 id="2-SHA1"><a href="#2-SHA1" class="headerlink" title="2.SHA1"></a>2.SHA1</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A &#x3D; 0x67452301</span><br><span class="line">B &#x3D; 0xEFCDAB89</span><br><span class="line">C &#x3D; 0x98BADCFE</span><br><span class="line">D &#x3D; 0x10325476</span><br><span class="line">E &#x3D; 0xC3D2E1F0</span><br><span class="line"></span><br><span class="line">和MD5相比，有五个初始化链接变量，而且前四个链接变量完全相同。</span><br><span class="line">输出长度20个字节，或者说40个十六进制数。</span><br><span class="line">只有四个K值，每20轮用同一个K作变换</span><br><span class="line"></span><br><span class="line">K1 &#x3D; 0x5a827999</span><br><span class="line">K2 &#x3D; 0x6ed9eba1</span><br><span class="line">K3 &#x3D; 0x8f1bbcdc</span><br><span class="line">K4 &#x3D; 0xca62c1d6</span><br></pre></td></tr></table></figure>
<h5 id="3-SHA256"><a href="#3-SHA256" class="headerlink" title="3.SHA256"></a>3.SHA256</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A &#x3D; 0x6A09E667;</span><br><span class="line">B &#x3D; 0xBB67AE85;</span><br><span class="line">C &#x3D; 0x3C6EF372;</span><br><span class="line">D &#x3D; 0xA54FF53A;</span><br><span class="line">E &#x3D; 0x510E527F;</span><br><span class="line">F &#x3D; 0x9B05688C;</span><br><span class="line">G &#x3D; 0x1F83D9AB;</span><br><span class="line">H &#x3D; 0x5BE0CD19;</span><br><span class="line"></span><br><span class="line">八个初始化链接变量</span><br><span class="line"></span><br><span class="line">输出长度为32个字节，或者说64个十六进制数</span><br><span class="line"></span><br><span class="line">有64个K值，每轮1个K值</span><br><span class="line"></span><br><span class="line">K1 &#x3D; 0x428a2f98</span><br><span class="line">K2 &#x3D; 0x71374491</span><br><span class="line">K3 &#x3D; 0xb5c0fbcf</span><br><span class="line">K4 &#x3D; 0xe9b5dba5</span><br><span class="line"></span><br><span class="line">K值来自素数</span><br></pre></td></tr></table></figure>
<h5 id="4-SHA-512"><a href="#4-SHA-512" class="headerlink" title="4. SHA 512"></a>4. SHA 512</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A &#x3D; 0x6a09e667f3bcc908;</span><br><span class="line">B &#x3D; 0xbb67ae8584caa73b;</span><br><span class="line">C &#x3D; 0x3c6ef372fe94f82b;</span><br><span class="line">D &#x3D; 0xa54ff53a5f1d36f1;</span><br><span class="line">E &#x3D; 0x510e527fade682d1;</span><br><span class="line">F &#x3D; 0x9b05688c2b3e6c1f;</span><br><span class="line">G &#x3D; 0x1f83d9abfb41bd6b;</span><br><span class="line">H &#x3D; 0x5be0cd19137e2179;</span><br><span class="line"></span><br><span class="line">八个初始化链接变量，IDA反编译也时常显示为16个。</span><br><span class="line"></span><br><span class="line">输出长度为64字节，或者说128个十六进制数</span><br><span class="line"></span><br><span class="line">有80个K，每一轮一个K，K值来自素数。</span><br><span class="line"></span><br><span class="line">K1 &#x3D; 0x428a2f98d728ae22</span><br><span class="line">K2 &#x3D; 0x7137449123ef65cd</span><br><span class="line">K3 &#x3D; 0xb5c0fbcfec4d3b2f</span><br><span class="line">K4 &#x3D; 0xe9b5dba58189dbbc</span><br><span class="line"></span><br><span class="line">和SHA256的K有关联。</span><br></pre></td></tr></table></figure>
<h5 id="5-HMAC-MD5"><a href="#5-HMAC-MD5" class="headerlink" title="5. HMAC-MD5"></a>5. HMAC-MD5</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">明文:123456(utf-8)</span><br><span class="line">秘钥:12345(utf-8)</span><br><span class="line">结果：b8e91a37b5a5b21ea7aec961b3eea43b</span><br><span class="line"></span><br><span class="line">ida 查找</span><br><span class="line">0x36363636363636</span><br><span class="line">0x5C5C</span><br></pre></td></tr></table></figure>
<h5 id="HMAC-MD5-过程"><a href="#HMAC-MD5-过程" class="headerlink" title="HMAC-MD5 过程"></a>HMAC-MD5 过程</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- input: &quot;123456&quot;</span><br><span class="line">- key:   &quot;r0ysue&quot;</span><br><span class="line">- output:7586ed47b719dc12503e3b296b7f6455</span><br><span class="line"></span><br><span class="line">### 第1步：密钥扩充</span><br><span class="line">K&#39; &#x3D; 7230797375650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line"></span><br><span class="line">### 第2步：</span><br><span class="line">opad &#x3D; 0x5c</span><br><span class="line">K&#39; ⊕ opad  &#x3D; 2e6c252f29395c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c</span><br><span class="line"></span><br><span class="line">### 第3步：</span><br><span class="line">ipad &#x3D; 0x36</span><br><span class="line">K&#39; ⊕ ipad &#x3D; 44064f45435336363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636</span><br><span class="line"></span><br><span class="line">### 第4步：</span><br><span class="line">( K&#39; ⊕ ipad ) || m &#x3D; 44064f45435336363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636313233343536</span><br><span class="line"></span><br><span class="line">### 第5步：</span><br><span class="line">H ( ( K&#39; ⊕ ipad ) || m ) &#x3D; caaf7af992267eb0e7fb35402ec5124b</span><br><span class="line"></span><br><span class="line">### 第6步：</span><br><span class="line"></span><br><span class="line">K&#39; ⊕ opad || H ( ( K&#39; ⊕ ipad ) || m ) &#x3D; 2e6c252f29395c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5c5ccaaf7af992267eb0e7fb35402ec5124b</span><br><span class="line"></span><br><span class="line">### 第7步：</span><br><span class="line">H（K&#39; ⊕ opad || H ( ( K&#39; ⊕ ipad ) || m )） &#x3D; 7586ed47b719dc12503e3b296b7f6455</span><br></pre></td></tr></table></figure>
<h4 id="哈希-ida插件使用"><a href="#哈希-ida插件使用" class="headerlink" title="哈希 ida插件使用"></a>哈希 ida插件使用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 将文件放入 IDA_Pro_v7.5_Portable\plugins</span><br><span class="line">2. 使用 Edit -&gt; Plugins -&gt; 插件</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/HongThatCong/FindCrypt3" target="_blank" rel="noopener">FindCrypt3</a></p>
<p><a href="https://github.com/L4ys/IDASignsrch" target="_blank" rel="noopener">IDASignsrch</a></p>
<p><a href="https://github.com/Pr0214/findhash" target="_blank" rel="noopener">findhash</a></p>
<p><a href="https://github.com/Pr0214/trace_natives" target="_blank" rel="noopener">trace_natives</a></p>
<h4 id="frida-hook-MD5"><a href="#frida-hook-MD5" class="headerlink" title="frida hook MD5"></a>frida hook MD5</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var algorithm &#x3D; &#39;MD5&#39;;</span><br><span class="line"></span><br><span class="line">if (Java.available) &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var MessageDigest &#x3D; Java.use(&#39;java.security.MessageDigest&#39;);</span><br><span class="line">        var digest1 &#x3D; MessageDigest.digest.overload(&quot;[B&quot;, &quot;int&quot;, &quot;int&quot;);</span><br><span class="line">        digest1.implementation &#x3D; function (buf, offset, len) &#123;</span><br><span class="line">            var ret &#x3D; digest2.call(this, buf);</span><br><span class="line">            parseIn(this, buf);</span><br><span class="line">            parseOut(this, ret);</span><br><span class="line">            return ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var digest2 &#x3D; MessageDigest.digest.overload(&quot;[B&quot;);</span><br><span class="line">        var update &#x3D; MessageDigest.update.overload(&quot;[B&quot;);</span><br><span class="line">        update.implementation &#x3D; function (buf) &#123;</span><br><span class="line">            parseIn(this, buf);</span><br><span class="line">            var ret &#x3D; this.update(buf);</span><br><span class="line">            return ret</span><br><span class="line">        &#125;</span><br><span class="line">        digest2.implementation &#x3D; function (buf) &#123;</span><br><span class="line">            var ret &#x3D; digest2.call(this, buf);</span><br><span class="line">            parseIn(this, buf);</span><br><span class="line">            parseOut(this, ret);</span><br><span class="line">            return ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function parseIn(digest, input) &#123;</span><br><span class="line">    var Integer &#x3D; Java.use(&#39;java.lang.Integer&#39;);</span><br><span class="line">    var String &#x3D; Java.use(&#39;java.lang.String&#39;);</span><br><span class="line">    if (digest.getAlgorithm() !&#x3D; algorithm) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        console.log(&quot;original-&gt; &quot; + String.$new(input));</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        console.log(parseHex(input));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function parseOut(digest, ret) &#123;</span><br><span class="line">    var Integer &#x3D; Java.use(&#39;java.lang.Integer&#39;);</span><br><span class="line">    var String &#x3D; Java.use(&#39;java.lang.String&#39;);</span><br><span class="line">    var result &#x3D; &quot;&quot;;</span><br><span class="line">    for (var i &#x3D; 0; i &lt; ret.length; i++) &#123;</span><br><span class="line">        var val &#x3D; ret[i];</span><br><span class="line">        if (val &lt; 0) &#123;</span><br><span class="line">            val +&#x3D; 256;</span><br><span class="line">        &#125;</span><br><span class="line">        var str &#x3D; Integer.toHexString(val);</span><br><span class="line">        if (String.$new(str).length() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            str &#x3D; &quot;0&quot; + str;</span><br><span class="line">        &#125;</span><br><span class="line">        result +&#x3D; str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (digest.getAlgorithm() &#x3D;&#x3D; algorithm) &#123;</span><br><span class="line">        console.log(digest.getAlgorithm() + &quot;(32):&quot; + result);</span><br><span class="line">        console.log(digest.getAlgorithm() + &quot;(16):&quot; + result.substring(8, 24));</span><br><span class="line">        console.log(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function parseHex(input) &#123;</span><br><span class="line">    var Integer &#x3D; Java.use(&#39;java.lang.Integer&#39;);</span><br><span class="line">    var byte_array &#x3D; &quot;&quot;;</span><br><span class="line">    for (var j &#x3D; 0; j &lt; input.length; j++) &#123;</span><br><span class="line">        var hex &#x3D; Integer.toHexString(input[j]);</span><br><span class="line">        if (hex.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            hex &#x3D; &quot;0&quot; + hex;</span><br><span class="line">        &#125;</span><br><span class="line">        byte_array +&#x3D; hex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    console.log(&quot;original(hex):&quot;);</span><br><span class="line">    var pair &#x3D; &quot;&quot;;</span><br><span class="line">    var hex_table &#x3D; &quot;&quot;;</span><br><span class="line">    for (var k &#x3D; 0; k &lt; byte_array.length; k++) &#123;</span><br><span class="line">        pair +&#x3D; byte_array.charAt(k);</span><br><span class="line">        if ((k + 1) % 2 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            pair +&#x3D; &quot; &quot;</span><br><span class="line">            hex_table +&#x3D; pair;</span><br><span class="line">            pair &#x3D; &quot;&quot;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((k + 1) % 32 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            hex_table +&#x3D; &quot;\n&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return hex_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>密码学</category>
      </categories>
      <tags>
        <tag>MD5</tag>
      </tags>
  </entry>
  <entry>
    <title>NDK JNI 开发</title>
    <url>/2022/04/04/NDK%E5%BC%80%E5%8F%91/</url>
    <content><![CDATA[<h3 id="NDK-官方文档"><a href="#NDK-官方文档" class="headerlink" title="NDK 官方文档"></a><a href="https://developer.android.com/ndk/guides" target="_blank" rel="noopener">NDK 官方文档</a></h3><h3 id="NDK-JNI简书文章介绍"><a href="#NDK-JNI简书文章介绍" class="headerlink" title="NDK JNI简书文章介绍"></a><a href="https://www.jianshu.com/p/87ce6f565d37" target="_blank" rel="noopener">NDK JNI简书文章介绍</a></h3><h3 id="NDK-JNI-开发"><a href="#NDK-JNI-开发" class="headerlink" title="NDK JNI 开发"></a>NDK JNI 开发</h3><h4 id="1-静态注册"><a href="#1-静态注册" class="headerlink" title="1. 静态注册"></a>1. 静态注册</h4><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static native String mdString(String string);</span><br></pre></td></tr></table></figure>
<p>native-lib.cpp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern &quot;C&quot; JNIEXPORT jstring JNICALL Java_com_jrb_easymd5_MainActivity_mdString(</span><br><span class="line">        JNIEnv *env, jclass obj, jstring str) &#123;....&#125;</span><br><span class="line">&#x2F;&#x2F; extern &quot;C&quot; JNIEXPORT 返回类型 JNICALL Java_包名_类名_方法名(JNIEnv *env, jclass obj, 入参)</span><br></pre></td></tr></table></figure>
<h4 id="2-动态注册-JNI-OnLoad-Native-化"><a href="#2-动态注册-JNI-OnLoad-Native-化" class="headerlink" title="2. 动态注册 JNI_OnLoad Native 化"></a>2. 动态注册 JNI_OnLoad Native 化</h4><p>native-lib.cpp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL ffff(JNIEnv *env, jclass jcls, jstring str_) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">static JNINativeMethod method_table[] &#x3D; &#123;</span><br><span class="line">        &#123;&quot;mdString&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;, (void *) ffff&#125;,</span><br><span class="line">       &#x2F;&#x2F; java方法名   signtrue 参数;结果                       native方法名</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int registerMethods(JNIEnv *env, const char *className,</span><br><span class="line">                           JNINativeMethod *gMethods, int numMethods) &#123;</span><br><span class="line">    jclass clazz &#x3D; env-&gt;FindClass(className);</span><br><span class="line">    if (clazz &#x3D;&#x3D; nullptr) &#123;</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    if (env-&gt;RegisterNatives(clazz, gMethods, numMethods) &lt; 0) &#123;</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    return JNI_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNI_OnLoad(JavaVM *vm, void *reserved) &#123;</span><br><span class="line">    JNIEnv *env &#x3D; nullptr;</span><br><span class="line">    if (vm-&gt;GetEnv((void **) &amp;env, JNI_VERSION_1_6) !&#x3D; JNI_OK) &#123;</span><br><span class="line">        return JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 注册native方法</span><br><span class="line">    if (!registerMethods(env,&quot;com&#x2F;jrb&#x2F;easymd5&#x2F;MainActivity&quot; , method_table, NELEM(method_table))) &#123;</span><br><span class="line">        &#x2F;&#x2F;                     java类                             方法              方法长度</span><br><span class="line">        return JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    return JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-native-调用java-方法"><a href="#3-native-调用java-方法" class="headerlink" title="3.native 调用java 方法"></a>3.native 调用java 方法</h4><p>MainActivity.java<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public native String Refmd5sec(String string); &#x2F;&#x2F; 动态实现</span><br><span class="line">public static native String Refmd5(String string);  &#x2F;&#x2F;静态实现</span><br><span class="line">public String Javamd5(String string) &#123;   &#x2F;&#x2F; java 实现MD5&#125;</span><br></pre></td></tr></table></figure><br>native-lib.cpp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern &quot;C&quot;</span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_roysue_easymd5_MainActivity_Refmd5sec(JNIEnv *env, jobject object, jstring string) &#123;</span><br><span class="line">    &#x2F;&#x2F; TODO: implement Refmd5sec()</span><br><span class="line">    jclass MainActivity &#x3D; env-&gt;FindClass(&quot;com&#x2F;roysue&#x2F;easymd5&#x2F;MainActivity&quot;);  &#x2F;&#x2F; 寻找类</span><br><span class="line">    jmethodID Javamd5 &#x3D; env-&gt;GetMethodID(MainActivity,&quot;Javamd5&quot;,&quot;(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;); &#x2F;&#x2F; 获得方法</span><br><span class="line">    jstring result &#x3D; static_cast&lt;jstring&gt;(env-&gt;CallObjectMethod(object,Javamd5,string) ); &#x2F;&#x2F; 调用动态方法</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern &quot;C&quot;</span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_roysue_easymd5_MainActivity_Refmd5(JNIEnv *env, jclass clazz, jstring string) &#123;</span><br><span class="line">    &#x2F;&#x2F; TODO: implement Refmd5()</span><br><span class="line">    &#x2F;&#x2F; MessageDigest md5 &#x3D; MessageDigest.getInstance(&quot;MD5&quot;);</span><br><span class="line">    jclass MessageDigest &#x3D; env-&gt;FindClass(&quot;java&#x2F;security&#x2F;MessageDigest&quot;); &#x2F;&#x2F; 寻找类</span><br><span class="line">    jmethodID getInstance &#x3D; env-&gt;GetStaticMethodID(MessageDigest,&quot;getInstance&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;security&#x2F;MessageDigest;&quot;);  &#x2F;&#x2F; 获得方法</span><br><span class="line">    jstring MD5 &#x3D; env-&gt;NewStringUTF(&quot;MD5&quot;);  &#x2F;&#x2F; 构造字符串</span><br><span class="line">    jobject md5 &#x3D; env-&gt;CallStaticObjectMethod(MessageDigest,getInstance,MD5);  &#x2F;&#x2F; 构造MD5对象</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; byte[] bytes &#x3D; md5.digest(string.getBytes());</span><br><span class="line">    jmethodID digest &#x3D; env-&gt;GetMethodID(MessageDigest,&quot;digest&quot;, &quot;([B)[B&quot;);</span><br><span class="line">    jclass stringClass &#x3D; env-&gt;FindClass(&quot;java&#x2F;lang&#x2F;String&quot;);</span><br><span class="line">    jmethodID getBytes &#x3D; env-&gt;GetMethodID(stringClass,&quot;getBytes&quot;, &quot;()[B&quot;); </span><br><span class="line">    jbyteArray jba &#x3D; static_cast&lt;jbyteArray&gt;(env-&gt;CallObjectMethod(string, getBytes)); &#x2F;&#x2F; 字符串转为数组</span><br><span class="line">    jbyteArray md5result &#x3D; static_cast&lt;jbyteArray&gt;(env-&gt;CallObjectMethod(md5, digest, jba)); &#x2F;&#x2F; 调用静态方法</span><br><span class="line"></span><br><span class="line">    char* cmd5 &#x3D; reinterpret_cast&lt;char *&gt;(env-&gt;GetByteArrayElements(md5result, 0));</span><br><span class="line">    int i;</span><br><span class="line">    char dest[32] &#x3D; &#123; 0 &#125;;</span><br><span class="line">    for (i &#x3D; 0; i &lt; 16; i++) &#123;</span><br><span class="line">        sprintf(dest + i * 2, &quot;%02x&quot;, (unsigned int) cmd5[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    return  env-&gt;NewStringUTF(dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-onCreate-native-化"><a href="#4-onCreate-native-化" class="headerlink" title="4.onCreate native 化"></a>4.onCreate native 化</h4><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@RequiresApi(api &#x3D; Build.VERSION_CODES.LOLLIPOP)</span><br><span class="line">@Override</span><br><span class="line">protected native void onCreate(Bundle savedInstanceState);</span><br></pre></td></tr></table></figure>
<p>native-lib.cpp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern &quot;C&quot;</span><br><span class="line">JNIEXPORT void JNICALL</span><br><span class="line">Java_com_jrb_easymd5_MainActivity_onCreate(JNIEnv *env, jobject thiz,</span><br><span class="line">                                           jobject saved_instance_state) &#123;</span><br><span class="line">    &#x2F;&#x2F; TODO: implement onCreate()</span><br><span class="line">        &#x2F;&#x2F;    super.onCreate(savedInstanceState);</span><br><span class="line">        jclass  AppCompatActivity &#x3D; env-&gt;FindClass(&quot;androidx&#x2F;appcompat&#x2F;app&#x2F;AppCompatActivity&quot;);</span><br><span class="line">        jmethodID  onCreate &#x3D; env-&gt;GetMethodID(AppCompatActivity, &quot;onCreate&quot;, &quot;(Landroid&#x2F;os&#x2F;Bundle;)V&quot;);</span><br><span class="line">        env-&gt;CallNonvirtualVoidMethod(thiz,AppCompatActivity,onCreate,saved_instance_state);</span><br><span class="line">        &#x2F;&#x2F;        setContentView(R.layout.activity_main);</span><br><span class="line">        jmethodID setContentView &#x3D; env-&gt;GetMethodID(AppCompatActivity,&quot;setContentView&quot;,&quot;(I)V&quot;);</span><br><span class="line">        jclass Rlayout &#x3D; env-&gt;FindClass(&quot;com&#x2F;jrb&#x2F;easymd5&#x2F;R$layout&quot;);</span><br><span class="line">        jfieldID activity_main &#x3D; env-&gt;GetStaticFieldID(Rlayout,&quot;activity_main&quot;,&quot;I&quot;);</span><br><span class="line">        jint activity_main_value &#x3D; env-&gt;GetStaticIntField(Rlayout, activity_main);</span><br><span class="line">        env-&gt;CallVoidMethod(thiz,setContentView,activity_main_value);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        TextView tv &#x3D; findViewById(R.id.sample_text);</span><br><span class="line">    jmethodID findViewById &#x3D; env-&gt;GetMethodID(AppCompatActivity,&quot;findViewById&quot;,&quot;(I)Landroid&#x2F;view&#x2F;View;&quot;);</span><br><span class="line">    jclass Rid &#x3D; env-&gt;FindClass(&quot;com&#x2F;jrb&#x2F;easymd5&#x2F;R$id&quot;);</span><br><span class="line">    jfieldID sample_text &#x3D; env-&gt;GetStaticFieldID(Rid,&quot;sample_text&quot;,&quot;I&quot;);</span><br><span class="line">    jint sample_text_value &#x3D; env-&gt;GetStaticIntField(Rid, sample_text);</span><br><span class="line">    jobject  tv &#x3D; env-&gt;CallObjectMethod(thiz,findViewById,sample_text_value);</span><br><span class="line">&#x2F;&#x2F;        tv.setText(&quot;12345jrb!&quot;);</span><br><span class="line">    jclass TextView &#x3D; env-&gt;FindClass(&quot;android&#x2F;widget&#x2F;TextView&quot;);</span><br><span class="line">    jmethodID setText &#x3D;  env-&gt;GetMethodID(TextView,&quot;setText&quot;,&quot;(Ljava&#x2F;lang&#x2F;CharSequence;)V&quot;);</span><br><span class="line">    env-&gt;CallVoidMethod(tv, setText,env-&gt;NewStringUTF(&quot;jrb!&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="objection-使用"><a href="#objection-使用" class="headerlink" title="objection 使用"></a>objection 使用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">objection -g com.jrb.easymd5 explore</span><br><span class="line">memory list modules &#x2F;&#x2F; 查看so</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/04/NDK%E5%BC%80%E5%8F%91/ndk1.png" alt="ndk1"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">memory list exports libnative-lib.so  &#x2F;&#x2F;查看导出符号</span><br></pre></td></tr></table></figure><br><img src="/2022/04/04/NDK%E5%BC%80%E5%8F%91/ndk2.png" alt="ndk2"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">objdump -T libnative-lib.so  |grep fff</span><br></pre></td></tr></table></figure></p>
<h4 id="函数的执行顺序"><a href="#函数的执行顺序" class="headerlink" title="函数的执行顺序"></a>函数的执行顺序</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. .init  .init_arrary , so feature   &#x3D; dlopen dlsym</span><br><span class="line">2. jni JNI_Onload    &#x3D; RegisterNatives</span><br><span class="line">3. so</span><br></pre></td></tr></table></figure>
<h4 id="frida-hook-libart-hook-art-使用"><a href="#frida-hook-libart-hook-art-使用" class="headerlink" title="frida_hook_libart hook_art 使用"></a><a href="https://github.com/lasting-yang/frida_hook_libart" target="_blank" rel="noopener">frida_hook_libart</a> hook_art 使用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida -U -f com.jrb.easymd5 -l hook_art.js</span><br><span class="line">&#x2F;&#x2F; so 调用栈 Backtracer.FUZZY 模糊  ACCURATE 详细</span><br><span class="line">&#x2F;&#x2F; console.log(&#39;CCCryptorCreate called from:\n&#39; + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join(&#39;\n&#39;) + &#39;\n&#39;);</span><br><span class="line">hook</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/04/NDK%E5%BC%80%E5%8F%91/ndk3.png" alt="ndk3"></p>
<h4 id="frida-hook-libart-hook-RegisterNatives-使用"><a href="#frida-hook-libart-hook-RegisterNatives-使用" class="headerlink" title="frida_hook_libart hook_RegisterNatives 使用"></a><a href="https://github.com/lasting-yang/frida_hook_libart" target="_blank" rel="noopener">frida_hook_libart</a> hook_RegisterNatives 使用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var ENV &#x3D; null;</span><br><span class="line">var JCLZ &#x3D; null;</span><br><span class="line"></span><br><span class="line">var method01addr &#x3D; null;</span><br><span class="line">var method02addr &#x3D; null;</span><br><span class="line">var method02 &#x3D; null;</span><br><span class="line"></span><br><span class="line">var addrNewStringUTF &#x3D; null;</span><br><span class="line"></span><br><span class="line">var NewStringUTF &#x3D; null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function hook_RegisterNatives() &#123;</span><br><span class="line">    var symbols &#x3D; Module.enumerateSymbolsSync(&quot;libart.so&quot;);</span><br><span class="line">    var addrRegisterNatives &#x3D; null;</span><br><span class="line">    for (var i &#x3D; 0; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        var symbol &#x3D; symbols[i];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi</span><br><span class="line">        if (symbol.name.indexOf(&quot;art&quot;) &gt;&#x3D; 0 &amp;&amp;</span><br><span class="line">                symbol.name.indexOf(&quot;JNI&quot;) &gt;&#x3D; 0 &amp;&amp; </span><br><span class="line">                symbol.name.indexOf(&quot;NewStringUTF&quot;) &gt;&#x3D; 0 &amp;&amp; </span><br><span class="line">                symbol.name.indexOf(&quot;CheckJNI&quot;) &lt; 0) &#123;</span><br><span class="line">            addrNewStringUTF &#x3D; symbol.address;</span><br><span class="line">            console.log(&quot;NewStringUTF is at &quot;, symbol.address, symbol.name);</span><br><span class="line">            NewStringUTF &#x3D; new NativeFunction(addrNewStringUTF,&#39;pointer&#39;,[&#39;pointer&#39;,&#39;pointer&#39;])</span><br><span class="line">        &#125;</span><br><span class="line">        if (symbol.name.indexOf(&quot;art&quot;) &gt;&#x3D; 0 &amp;&amp;</span><br><span class="line">                symbol.name.indexOf(&quot;JNI&quot;) &gt;&#x3D; 0 &amp;&amp; </span><br><span class="line">                symbol.name.indexOf(&quot;RegisterNatives&quot;) &gt;&#x3D; 0 &amp;&amp; </span><br><span class="line">                symbol.name.indexOf(&quot;CheckJNI&quot;) &lt; 0) &#123;</span><br><span class="line">            addrRegisterNatives &#x3D; symbol.address;</span><br><span class="line">            console.log(&quot;RegisterNatives is at &quot;, symbol.address, symbol.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (addrRegisterNatives !&#x3D; null) &#123;</span><br><span class="line">        Interceptor.attach(addrRegisterNatives, &#123;</span><br><span class="line">            onEnter: function (args) &#123;</span><br><span class="line">                console.log(&quot;[RegisterNatives] method_count:&quot;, args[3]);</span><br><span class="line">                var env &#x3D; args[0];</span><br><span class="line">                ENV &#x3D; args[0];</span><br><span class="line">                var java_class &#x3D; args[1];</span><br><span class="line">                JCLZ &#x3D; args[1];</span><br><span class="line">                var class_name &#x3D; Java.vm.tryGetEnv().getClassName(java_class);</span><br><span class="line">                &#x2F;&#x2F;console.log(class_name);</span><br><span class="line"></span><br><span class="line">                var methods_ptr &#x3D; ptr(args[2]);</span><br><span class="line"></span><br><span class="line">                var method_count &#x3D; parseInt(args[3]);</span><br><span class="line">                for (var i &#x3D; 0; i &lt; method_count; i++) &#123;</span><br><span class="line">                    var name_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3));</span><br><span class="line">                    var sig_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize));</span><br><span class="line">                    var fnPtr_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize * 2));</span><br><span class="line"></span><br><span class="line">                    var name &#x3D; Memory.readCString(name_ptr);</span><br><span class="line">                    var sig &#x3D; Memory.readCString(sig_ptr);</span><br><span class="line">                    var find_module &#x3D; Process.findModuleByAddress(fnPtr_ptr);</span><br><span class="line">                    console.log(&quot;[RegisterNatives] java_class:&quot;, class_name, &quot;name:&quot;, name, &quot;sig:&quot;, sig, &quot;fnPtr:&quot;, fnPtr_ptr, &quot;module_name:&quot;, find_module.name, &quot;module_base:&quot;, find_module.base, &quot;offset:&quot;, ptr(fnPtr_ptr).sub(find_module.base));</span><br><span class="line">                    if(name.indexOf(&quot;method01&quot;)&gt;&#x3D;0)&#123;</span><br><span class="line">                        &#x2F;&#x2F; method01addr &#x3D; fnPtr_ptr;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;else if (name.indexOf(&quot;decrypt&quot;)&gt;&#x3D;0)&#123;</span><br><span class="line">                        method02addr &#x3D; fnPtr_ptr;</span><br><span class="line">                        method02 &#x3D; new NativeFunction(method02addr,&#39;pointer&#39;,[&#39;pointer&#39;,&#39;pointer&#39;,&#39;pointer&#39;]);</span><br><span class="line">                        method01addr &#x3D; Module.findExportByName(&quot;libroysue.so&quot;, &quot;Java_com_roysue_easyso1_MainActivity_method01&quot;)</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function invokemethod01(contents)&#123;</span><br><span class="line">    </span><br><span class="line">    console.log(&quot;method01_addr is &#x3D;&gt;&quot;,method01addr)</span><br><span class="line">    var method01 &#x3D; new NativeFunction(method01addr,&#39;pointer&#39;,[&#39;pointer&#39;,&#39;pointer&#39;,&#39;pointer&#39;]);</span><br><span class="line">    var NewStringUTF &#x3D; new NativeFunction(addrNewStringUTF,&#39;pointer&#39;,[&#39;pointer&#39;,&#39;pointer&#39;])</span><br><span class="line">    var result &#x3D; null;</span><br><span class="line">    Java.perform(function()&#123;    </span><br><span class="line">        console.log(&quot;Java.vm.getEnv()&quot;,Java.vm.getEnv())</span><br><span class="line">        var JSTRING &#x3D; NewStringUTF(Java.vm.getEnv(),Memory.allocUtf8String(contents))</span><br><span class="line">        result &#x3D; method01(Java.vm.getEnv(),JSTRING,JSTRING);</span><br><span class="line">        console.log(&quot;result is &#x3D;&gt;&quot;,result)</span><br><span class="line">        console.log(&quot;result is &quot;,Java.vm.getEnv().getStringUtfChars(result, null).readCString())</span><br><span class="line">        result &#x3D; Java.vm.getEnv().getStringUtfChars(result, null).readCString();</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function invokemethod02(contents)&#123;</span><br><span class="line">    var result &#x3D; null;</span><br><span class="line">    Java.perform(function()&#123;    </span><br><span class="line">        var JSTRING &#x3D; NewStringUTF(Java.vm.getEnv(),Memory.allocUtf8String(contents))</span><br><span class="line">        result &#x3D; method02(Java.vm.getEnv(),JSTRING,JSTRING);</span><br><span class="line">        result &#x3D; Java.vm.getEnv().getStringUtfChars(result, null).readCString();</span><br><span class="line">    &#125;)</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="hook-dlopen"><a href="#hook-dlopen" class="headerlink" title="hook_dlopen"></a>hook_dlopen</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var is_hook_libart &#x3D; false;</span><br><span class="line"></span><br><span class="line">function hook_dlopen() &#123;</span><br><span class="line">    Interceptor.attach(Module.findExportByName(null, &quot;dlopen&quot;), &#123;</span><br><span class="line">        onEnter: function(args) &#123;</span><br><span class="line">            var pathptr &#x3D; args[0];</span><br><span class="line">            if (pathptr !&#x3D;&#x3D; undefined &amp;&amp; pathptr !&#x3D; null) &#123;</span><br><span class="line">                var path &#x3D; ptr(pathptr).readCString();</span><br><span class="line">                console.log(&quot;dlopen:&quot;, path);</span><br><span class="line">                if (path.indexOf(&quot;libroysue.so&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                    this.can_hook_libart &#x3D; true;</span><br><span class="line">                    console.log(&quot;[dlopen:]&quot;, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: function(retval) &#123;</span><br><span class="line">            if (this.can_hook_libart &amp;&amp; !is_hook_libart) &#123;                </span><br><span class="line">                is_hook_libart &#x3D; true;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(null, &quot;android_dlopen_ext&quot;), &#123;</span><br><span class="line">        onEnter: function(args) &#123;</span><br><span class="line">            var pathptr &#x3D; args[0];</span><br><span class="line">            if (pathptr !&#x3D;&#x3D; undefined &amp;&amp; pathptr !&#x3D; null) &#123;</span><br><span class="line">                var path &#x3D; ptr(pathptr).readCString();</span><br><span class="line">                console.log(&quot;android_dlopen_ext:&quot;, path);</span><br><span class="line">                if (path.indexOf(&quot;libroysue.so&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                    this.can_hook_libart &#x3D; true;</span><br><span class="line">                    console.log(&quot;[android_dlopen_ext:]&quot;, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: function(retval) &#123;</span><br><span class="line">            if (this.can_hook_libart &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                is_hook_libart &#x3D; true;</span><br><span class="line">                var method01 &#x3D; Module.findExportByName(&quot;libroysue.so&quot;, &quot;Java_com_roysue_easyso1_MainActivity_method01&quot;)</span><br><span class="line">                var method02 &#x3D; Module.findExportByName(&quot;libroysue.so&quot;, &quot;_Z8method02P7_JNIEnvP7_jclassP8_jstring&quot;)</span><br><span class="line">                console.log(&quot;method01 address is &#x3D;&gt;&quot;,method01)</span><br><span class="line">                console.log(&quot;method02 address is &#x3D;&gt;&quot;,method02)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    hook_dlopen()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<h4 id="Simp1er-hook-RegisterNative"><a href="#Simp1er-hook-RegisterNative" class="headerlink" title="Simp1er hook_RegisterNative"></a><a href="https://github.com/Simp1er/AndroidSec/blob/master/hook_RegisterNative.js" target="_blank" rel="noopener">Simp1er hook_RegisterNative</a></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">仅在Android 8.1下测试成功，其他版本可能需要重新修改适配</span><br><span class="line">*&#x2F;</span><br><span class="line">const STD_STRING_SIZE &#x3D; 3 * Process.pointerSize;</span><br><span class="line">class StdString &#123;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        this.handle &#x3D; Memory.alloc(STD_STRING_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dispose() &#123;</span><br><span class="line">        const [data, isTiny] &#x3D; this._getData();</span><br><span class="line">        if (!isTiny) &#123;</span><br><span class="line">            Java.api.$delete(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    disposeToString() &#123;</span><br><span class="line">        const result &#x3D; this.toString();</span><br><span class="line">        this.dispose();</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    toString() &#123;</span><br><span class="line">        const [data] &#x3D; this._getData();</span><br><span class="line">        return data.readUtf8String();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _getData() &#123;</span><br><span class="line">        const str &#x3D; this.handle;</span><br><span class="line">        const isTiny &#x3D; (str.readU8() &amp; 1) &#x3D;&#x3D;&#x3D; 0;</span><br><span class="line">        const data &#x3D; isTiny ? str.add(1) : str.add(2 * Process.pointerSize).readPointer();</span><br><span class="line">        return [data, isTiny];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function prettyMethod(method_id, withSignature) &#123;</span><br><span class="line">    const result &#x3D; new StdString();</span><br><span class="line">    Java.api[&#39;art::ArtMethod::PrettyMethod&#39;](result, method_id, withSignature ? 1 : 0);</span><br><span class="line">    return result.disposeToString();</span><br><span class="line">&#125;</span><br><span class="line">function attach(addr) &#123;</span><br><span class="line">    Interceptor.attach(addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0]</span><br><span class="line">        &#125;, </span><br><span class="line">        onLeave: function (retval) &#123;</span><br><span class="line">            var modulemap &#x3D; new ModuleMap()</span><br><span class="line">            modulemap.update()</span><br><span class="line">            var module &#x3D; modulemap.find(retval)</span><br><span class="line">            var string &#x3D; Memory.alloc(0x100)</span><br><span class="line">            if (module !&#x3D; null) &#123;</span><br><span class="line">                console.log(&#39;&lt;&#39; + module.name + &#39;&gt; method_name &#x3D;&gt;&#39;,prettyMethod(this.arg0,1), &#39;,offset&#x3D;&gt;&#39;, ptr(retval).sub(module.base), &#39;,module_name&#x3D;&gt;&#39;, module.name)</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                console.log(&#39;&lt;anonymous&gt; method_name &#x3D;&gt;&#39;, readStdString(string), &#39;, addr &#x3D;&gt;&#39;, ptr(retval))</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">                if(readStdString(string).indexOf(&quot;method01&quot;)&gt;&#x3D;0)&#123;</span><br><span class="line">                    Interceptor.attach(ptr(retval),&#123;</span><br><span class="line">                        onEnter:function(args)&#123;</span><br><span class="line">                            console.log(&quot;entering method01&quot;,Java.vm.getEnv().getStringUtfChars(args[2], null).readCString())</span><br><span class="line">                        &#125;,onLeave:function()&#123;</span><br><span class="line">                            console.log(&quot;leaving method01&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;;</span><br><span class="line">                            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hook_RegisterNative() &#123;</span><br><span class="line">    var libart &#x3D; Process.findModuleByName(&#39;libart.so&#39;)</span><br><span class="line">    var symbols &#x3D; libart.enumerateSymbols()</span><br><span class="line">    for (var i &#x3D; 0; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        if (symbols[i].name.indexOf(&#39;RegisterNative&#39;) &gt; -1 &amp;&amp; symbols[i].name.indexOf(&#39;ArtMethod&#39;) &gt; -1 &amp;&amp; symbols[i].name.indexOf(&#39;RuntimeCallbacks&#39;) &lt; 0) &#123;</span><br><span class="line">            attach(symbols[i].address)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">function main() &#123;</span><br><span class="line">    hook_RegisterNative()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<h4 id="jnitrace-trace"><a href="#jnitrace-trace" class="headerlink" title="jnitrace trace"></a><a href="https://github.com/chame1eon/jnitrace" target="_blank" rel="noopener">jnitrace</a> trace</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jnitrace -l libnative-lib.so com.jrb.easymd5</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/04/NDK%E5%BC%80%E5%8F%91/ndk4.png" alt="ndk4"></p>
]]></content>
      <categories>
        <category>开发</category>
      </categories>
      <tags>
        <tag>NDK</tag>
        <tag>JNI</tag>
      </tags>
  </entry>
  <entry>
    <title>Base64</title>
    <url>/2022/04/07/Base64/</url>
    <content><![CDATA[<h3 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a>Base64</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Base64的码表只有64个字符， 如果要表达64个字符的话，使用6的bit即可完全表示(2的6次方为64)。</span><br><span class="line">因为Base64的编码只有6个bit即可表示，而正常的字符是使用8个bit表示， 8和6的最小公倍数是24，所以4个Base64字符可以表示3个标准的ascll字符；</span><br><span class="line">如果是字符串转换为Base64码， 会先把对应的字符串转换为ascll码表对应的数字， 然后再把数字转换为2进制， 比如a的ascll码味97， 97的二进制是：01100001， 把8个二进制提取成6个，剩下的2个二进制和后面的二进制继续拼接， 最后再把6个二进制码转换为Base64对于的编</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符串      a       b        c</span><br><span class="line">ASCII      97      98       99</span><br><span class="line">8bit   01100001 01100010 01100011</span><br><span class="line">6bit   011000   010110   001001   100011</span><br><span class="line">十进制      24      22        9        35</span><br><span class="line">对应编码    Y        W        J        j</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/07/Base64/base64原理1.png" alt="base64原理1"><br><img src="/2022/04/07/Base64/base64原理1.png" alt="base64原理2"></p>
<h4 id="Android-Studio-实现简单base64的方法"><a href="#Android-Studio-实现简单base64的方法" class="headerlink" title="Android Studio 实现简单base64的方法"></a>Android Studio 实现简单base64的方法</h4><p>MainActivity.java<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jrb.base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        <span class="comment">//String encode = Base64.encodeToString("A".getBytes(), Base64.DEFAULT);</span></span><br><span class="line">        tv.setText(base64enc(<span class="string">"jrbtest"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">base64enc</span><span class="params">(String str)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>native-lib.cpp<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 码表</span><br><span class="line">static const char base64en[] &#x3D; &#123;&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;,  &#39;I&#39;, &#39;J&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;, &#39;N&#39;, &#39;O&#39;, &#39;P&#39;,  &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;U&#39;, &#39;V&#39;, &#39;W&#39;, &#39;X&#39;,   &#39;Y&#39;, &#39;Z&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;,&#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;l&#39;, &#39;m&#39;, &#39;n&#39;, &#39;o&#39;, &#39;p&#39;, &#39;q&#39;, &#39;r&#39;, &#39;s&#39;, &#39;t&#39;, &#39;u&#39;, &#39;v&#39;,  &#39;w&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;, &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;+&#39;, &#39;&#x2F;&#39;&#125;;</span><br><span class="line">static const char base64_pad &#x3D; &#39;&#x3D;&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void base64_enc(const char *data, char *out)&#123;</span><br><span class="line">    &#x2F;&#x2F; data: jrb</span><br><span class="line">    &#x2F;&#x2F; base64 编码</span><br><span class="line">    int len_data &#x3D; strlen(data);</span><br><span class="line">    if (len_data &#x3D;&#x3D; 0)&#123;</span><br><span class="line">        out[0] &#x3D; &#39;\0&#39;;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    int index &#x3D; 0;</span><br><span class="line">    char last_c &#x3D; &#39;\0&#39;;</span><br><span class="line">    char c &#x3D; &#39;\0&#39;;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; len_data; ++i) &#123;</span><br><span class="line">        c &#x3D; data[i];</span><br><span class="line">        switch (i % 3) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                out[index++] &#x3D; base64en[( c &gt;&gt; 2 ) &amp; 0x3f];  &#x2F;&#x2F;向右移2位</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                 out[index++] &#x3D; base64en[( ( last_c &amp; 0x3 ) &lt;&lt; 4 )| (( c &gt;&gt; 4 ) &amp; 0xf)];  &#x2F;</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                out[index++] &#x3D; base64en[ ( ( last_c &amp; 0xf ) &lt;&lt; 2 ) | ((c &gt;&gt; 6) &amp; 0x3) ];</span><br><span class="line">                out[index++] &#x3D; base64en[c &amp; 0x3f];</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        last_c &#x3D; c;</span><br><span class="line">    &#125;</span><br><span class="line">    if (len_data % 3 &#x3D;&#x3D; 1)&#123;</span><br><span class="line">        out[index++] &#x3D; base64en[(c &amp; 0x3) &lt;&lt; 4];</span><br><span class="line">        out[index++] &#x3D; base64_pad;</span><br><span class="line">        out[index++] &#x3D; base64_pad;</span><br><span class="line">    &#125; else if(len_data % 3 &#x3D;&#x3D; 2)&#123;</span><br><span class="line">        out[index++] &#x3D; base64en[(c &amp; 0xf) &lt;&lt; 2];</span><br><span class="line">        out[index++] &#x3D; base64_pad;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot;</span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_jrb_base64_MainActivity_base64enc(JNIEnv *env, jobject thiz, jstring str) &#123;</span><br><span class="line">    const char *data &#x3D; env-&gt;GetStringUTFChars(str,NULL);</span><br><span class="line">    char out[100] &#x3D; &#123;0&#125;;</span><br><span class="line">    base64_enc(data,out);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(str,data);</span><br><span class="line">    return env-&gt;NewStringUTF(out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="hook-base64"><a href="#hook-base64" class="headerlink" title="hook base64"></a>hook base64</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base64Class = Java.use(<span class="string">"android.util.Base64"</span>);</span><br><span class="line">    <span class="keyword">var</span> str = Java.use(<span class="string">"android.util.Base64"</span>);</span><br><span class="line">    base64Class.encodeToString.overload(<span class="string">'[B'</span>, <span class="string">'int'</span>).implementations = <span class="function"><span class="keyword">function</span> (<span class="params">a1, a2</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">123</span>)</span><br><span class="line">        <span class="keyword">var</span> res = <span class="keyword">this</span>.encodeToString(a1, a2)</span><br><span class="line">        <span class="built_in">console</span>.log(a1, a2)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>密码学</category>
      </categories>
      <tags>
        <tag>Base64</tag>
      </tags>
  </entry>
  <entry>
    <title>RC4</title>
    <url>/2022/04/06/RC4/</url>
    <content><![CDATA[<h3 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RC4算法是一个可变密钥长度、面向字节操作的流密码。该算法以随机置换作为基础，其密码周期很可能大于10^100，且该算法的运行速度很快。</span><br><span class="line">RC4被用于为网络浏览器和服务器间通信而制定的SSL&#x2F;TLS（安全套接字协议&#x2F;传输层安全协议）标准中</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/06/RC4/rc4.png" alt="rc411"></p>
<h4 id="rc4的详解"><a href="#rc4的详解" class="headerlink" title="rc4的详解"></a>rc4的详解</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.S和T的初始状态：</span><br><span class="line">	S中元素的值按升序被置为0-255，同时建立一个临时向量T。将密钥的值循环复制到T向量中。</span><br><span class="line">　　for (i &#x3D; 0; i &lt; 256; ++i) &#123;</span><br><span class="line">        	S[i] &#x3D; i;</span><br><span class="line">        	T[i] &#x3D; K[i mod len];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">2.S的初始置换：    用T产生S的初始置换</span><br><span class="line">　    j &#x3D; 0;</span><br><span class="line">　　for (i &#x3D; 0 ; i &lt; 256 ; i++)&#123;</span><br><span class="line">　　　　j &#x3D; (j + S[i] + T[i]) mod 256;</span><br><span class="line">　　　　swap(S[i] , S[j]);</span><br><span class="line">　　&#125;</span><br><span class="line"></span><br><span class="line">3. 密钥流的生成：	    用T产生S的初始置换</span><br><span class="line">　　i , j &#x3D; 0;</span><br><span class="line">　　while (true)&#123;</span><br><span class="line">　　　　i &#x3D; (i + 1) mod 256;</span><br><span class="line">　　　　j &#x3D; (j + S[i]) mod 256;</span><br><span class="line">　　　　swap(S[i] , S[j]);</span><br><span class="line">　　　　t &#x3D; (S[i] + S[j]) mod 256;</span><br><span class="line">　　　　k &#x3D; S[t];</span><br><span class="line">　　&#125;</span><br><span class="line">加密中，将k的值与明文的下一字节异或，解密时将k的值与密文的下一字节异或。</span><br></pre></td></tr></table></figure>
<h4 id="Android-Studio-实现"><a href="#Android-Studio-实现" class="headerlink" title="Android Studio 实现"></a>Android Studio 实现</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void rc4_init(unsigned char *S, char *K, int len)&#123;</span><br><span class="line">    char T[256] &#x3D; &#123;0&#125;;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; 256; ++i) &#123;</span><br><span class="line">        S[i] &#x3D; i;</span><br><span class="line">        T[i] &#x3D; K[i % len];</span><br><span class="line">    &#125;</span><br><span class="line">    int j &#x3D; 0;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; 256; ++i) &#123;</span><br><span class="line">        j &#x3D; (j + S[i] + T[i]) % 256;</span><br><span class="line">        swap(S[i],S[j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void rc4_enc(unsigned char *S, char *content, int len)&#123;</span><br><span class="line">   int i &#x3D; 0, j &#x3D; 0, t &#x3D; 0;</span><br><span class="line">    for (int k &#x3D; 0; k &lt; len; ++k) &#123;</span><br><span class="line">        i &#x3D; (i + 1) % 256;</span><br><span class="line">        j &#x3D; (j + S[i]) % 256;</span><br><span class="line">        swap(S[i] , S[j]);</span><br><span class="line">        t &#x3D; (S[i] + S[j]) % 256;</span><br><span class="line">        content[k] ^&#x3D; S[t];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern &quot;C&quot;</span><br><span class="line">JNIEXPORT void JNICALL</span><br><span class="line">Java_com_kanxue_rc4_MainActivity_rc4_1enc(JNIEnv *env, jobject thiz, jbyteArray data) &#123;</span><br><span class="line">    jbyte *j_byte_data &#x3D; env-&gt;GetByteArrayElements(data,0);</span><br><span class="line">    char *content &#x3D; reinterpret_cast&lt;char *&gt;(j_byte_data);</span><br><span class="line">    env-&gt;ReleaseByteArrayElements(data,j_byte_data,0);</span><br><span class="line">    unsigned char S[256];</span><br><span class="line">    char *K &#x3D; &quot;12345&quot;;</span><br><span class="line">    rc4_init(S,K,5);</span><br><span class="line">    rc4_enc(S,content,strlen(content));</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO,&quot;jrb&#x3D;&#x3D;&gt;&quot;,&quot;rc4_enc: %s&quot;,content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>密码学</category>
      </categories>
      <tags>
        <tag>RC4</tag>
      </tags>
  </entry>
  <entry>
    <title>Android逆向之某物newSign</title>
    <url>/2022/03/21/dewu/</url>
    <content><![CDATA[<h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app version: 4.69.5</span><br><span class="line">手机: Piexl3 XL  Android 10 </span><br><span class="line">抓包: charles + SagerNet</span><br><span class="line">用到的工具: jadx, frida, ida</span><br></pre></td></tr></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.利用 charles + SagerNet, 抓详商品详情页的包，很明显 newSign就是我们要分析的参数</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/21/dewu/img.png" alt="抓包"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2.打开心爱的jadx 搜索 &quot;newSign&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/21/dewu/img_1.png" alt="jadx搜索"><br><img src="/2022/03/21/dewu/img_2.png" alt="jadx搜索"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">3. 确定java成加密函数位置， 上我们的frida 看看效果</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_newSign</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> RequestUtilsCls = Java.use(<span class="string">'com.shizhuang.duapp.common.utils.RequestUtils'</span>);</span><br><span class="line"></span><br><span class="line">		RequestUtilsCls.a.overload(<span class="string">'java.util.Map'</span>, <span class="string">'long'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> rc = <span class="keyword">this</span>.a(a,b);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"a= "</span> + a.entrySet().toArray());</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"b= "</span> + b);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"a &gt;&gt;&gt; rc= "</span> + rc);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> rc ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		RequestUtilsCls.b.overload(<span class="string">'java.util.Map'</span>, <span class="string">'long'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> rc = <span class="keyword">this</span>.b(a,b);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"a= "</span> + a.entrySet().toArray());</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"b= "</span> + b);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"b &gt;&gt;&gt; rc= "</span> + rc);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> rc ;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		RequestUtilsCls.c.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> rc = <span class="keyword">this</span>.c(a,b);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"a= "</span> + a.entrySet().toArray());</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"b= "</span> + b);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">"c &gt;&gt;&gt; rc= "</span> + rc);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> rc ;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/21/dewu/img_4.png" alt="抓包"><br><img src="/2022/03/21/dewu/img_5.png" alt="frida"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">4. charles 抓包和 frida hook 的值是一样的</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/21/dewu/img_3.png" alt="jadx搜索"><br><img src="/2022/03/21/dewu/img_6.png" alt="jadx搜索"><br><img src="/2022/03/21/dewu/img_7.png" alt="jadx搜索"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5.  通过jadx 分析可知  </span><br><span class="line">    有map传一些参数 在加上 uuid等参数结果 进行排序在</span><br><span class="line">    在调用native encodeByte方法加密后的结果</span><br><span class="line">    在进行MD5加密</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6. 通过ida 分析JNIEncrypt.so  是不同aes  利用frida hook so</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/21/dewu/img_8.png" alt="img_8.png"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookencodeByte</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> encrypt_addr = Module.findExportByName(<span class="string">'libJNIEncrypt.so'</span>,<span class="string">'AES_128_ECB_PKCS5Padding_Encrypt'</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'encrypt_addr'</span>,encrypt_addr);</span><br><span class="line">	<span class="keyword">if</span>(encrypt_addr)&#123;</span><br><span class="line">	  Interceptor.attach(encrypt_addr,&#123;</span><br><span class="line">		onEnter:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">		  <span class="built_in">console</span>.log(<span class="string">"arg0"</span>,args[<span class="number">0</span>].readCString());</span><br><span class="line">		  <span class="built_in">console</span>.log(<span class="string">"arg1"</span>,args[<span class="number">1</span>].readCString());</span><br><span class="line">		   </span><br><span class="line">		  <span class="comment">// var byteArray = args[0].readByteArray(200);</span></span><br><span class="line">		&#125;,</span><br><span class="line">		onLeave:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">		  <span class="built_in">console</span>.log(<span class="string">"result"</span>,retval.readCString());</span><br><span class="line">		&#125;</span><br><span class="line">	  &#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hook 的结果</span><br><span class="line"></span><br><span class="line">arg0 challengecf4224d39199d7017732c4aa5c0fa589loginTokenplatformandroidresult0serverStatus1timestamp1646594165319uuidb4f11c0b0518dd0ev4.69.5</span><br><span class="line">arg1 d245a0ba8d678a61</span><br><span class="line">result A5855EjJgrjeqGjxyCv7pRaG6k3hkxZxDuivETnxkXFd6XXU01lZIAn4PHmhL0sVXi04qk3dcDCGELQKDYtgZs&#x2F;shP7O8MxJkrDGX5Z7IVP6oeRRKF0GbSL9aaJnLpyUKdxTLvfU4Z6bXv7btRBrQZzP9Aw2U8j&#x2F;aY8u+dxdWXGnmOcWBZJM5nr3QZSBtpG6</span><br></pre></td></tr></table></figure>
<p>打开加密网址<a href="https://gchq.github.io/CyberChef/" target="_blank" rel="noopener">CyberChef</a><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">发现 so 加密就是普通的aes ecs PKCS5Padding 加密</span><br></pre></td></tr></table></figure><br><img src="/2022/03/21/dewu/img_9.png" alt="img_9.png"></p>
<p>python版 aes<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncryptDate</span>:</span></span><br><span class="line">    <span class="comment"># AEC CBC BASE64</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.key = key  <span class="comment"># 初始化密钥</span></span><br><span class="line">        self.length = AES.block_size  <span class="comment"># 初始化数据块大小</span></span><br><span class="line">        self.aes = AES.new(self.key, AES.MODE_ECB)  <span class="comment"># 初始化AES,ECB模式的实例</span></span><br><span class="line">        <span class="comment"># 截断函数，去除填充的字符</span></span><br><span class="line">        self.unpad = <span class="keyword">lambda</span> date: date[<span class="number">0</span>:-ord(date[<span class="number">-1</span>])]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pad</span><span class="params">(self, text)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        #填充函数，使被加密数据的字节码长度是block_size的整数倍</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        count = len(text.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        add = self.length - (count % self.length)</span><br><span class="line">        entext = text + (chr(add) * add)</span><br><span class="line">        <span class="keyword">return</span> entext</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, encrData)</span>:</span>  <span class="comment"># 加密函数</span></span><br><span class="line">        res = self.aes.encrypt(self.pad(encrData).encode(<span class="string">"utf8"</span>))</span><br><span class="line">        msg = (base64.b64encode(res)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self, decrData)</span>:</span>  <span class="comment"># 解密函数</span></span><br><span class="line">        res = base64.decodebytes(decrData.encode(<span class="string">"utf8"</span>))</span><br><span class="line">        msg = self.aes.decrypt(res).decode(<span class="string">"utf8"</span>)</span><br><span class="line">        <span class="keyword">return</span> self.unpad(msg)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">不过得物难点是在 极验点选 和 数美风控上</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>xposed 的基本使用</title>
    <url>/2022/03/30/Xposed/</url>
    <content><![CDATA[<h4 id="官网Api"><a href="#官网Api" class="headerlink" title="官网Api"></a><a href="https://api.xposed.info/reference/packages.html" target="_blank" rel="noopener">官网Api</a></h4><h4 id="新手入门文章"><a href="#新手入门文章" class="headerlink" title="新手入门文章"></a><a href="https://www.freebuf.com/articles/terminal/189021.html" target="_blank" rel="noopener">新手入门文章</a></h4><h4 id="xposed-创建"><a href="#xposed-创建" class="headerlink" title="xposed 创建"></a>xposed 创建</h4><ol>
<li><p>在/app/src/main/AndroidManifest.xml 添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name&#x3D;&quot;xposedmodule&quot;</span><br><span class="line">    android:value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name&#x3D;&quot;xposeddescription&quot;</span><br><span class="line">    android:value&#x3D;&quot;这是一个Xposed例程&quot; &#x2F;&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name&#x3D;&quot;xposedminversion&quot;</span><br><span class="line">    android:value&#x3D;&quot;53&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>/app/src、build.gradle 添加</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly &#39;de.robv.android.xposed:api:82&#39;</span><br><span class="line">    compileOnly &#39;de.robv.android.xposed:api:82:sources&#39;</span><br><span class="line"></span><br><span class="line">    implementation &#39;androidx.appcompat:appcompat:1.1.0&#39;</span><br><span class="line">    implementation &#39;com.google.android.material:material:1.1.0&#39;</span><br><span class="line">    implementation &#39;androidx.constraintlayout:constraintlayout:1.1.3&#39;</span><br><span class="line">    testImplementation &#39;junit:junit:4.+&#39;</span><br><span class="line">    androidTestImplementation &#39;androidx.test.ext:junit:1.1.1&#39;</span><br><span class="line">    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.2.0&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写hook代码 HookTest.java</p>
</li>
<li><p>右键点击 “main ” 文件夹 ， 选择new —&gt; Folder —&gt;Assets Folder，新建assets 文件夹 在建xposed_init文件，里面填写hook脚本文件路径<br>  <img src="/2022/03/30/Xposed/img.png" alt="img.png"></p>
</li>
</ol>
<h4 id="hook-构造函数"><a href="#hook-构造函数" class="headerlink" title="hook 构造函数"></a>hook 构造函数</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.jrb.xposeddemo;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.XposedBridge;</span><br><span class="line">import de.robv.android.xposed.XposedHelpers;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line">public class hook1 implements IXposedHookLoadPackage&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        if (lpparam.packageName.equals(&quot;com.jrb.mytest&quot;))&#123;  &#x2F;&#x2F;过滤包名</span><br><span class="line">            Class myclass &#x3D; lpparam.classLoader.loadClass(&quot;com.jrb.mytest.teacher&quot;);  &#x2F;&#x2F; 找到class</span><br><span class="line"></span><br><span class="line">            XposedHelpers.findAndHookConstructor(myclass, new XC_MethodHook() &#123;  &#x2F;&#x2F; 编写hook </span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.beforeHookedMethod(param);</span><br><span class="line">                    Log.e(&quot;jrb1&quot;, &quot;teacher is called&quot;);</span><br><span class="line">                    XposedBridge.log(&quot;teacher is called&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.afterHookedMethod(param);</span><br><span class="line">                    Log.e(&quot;jrb1&quot;, &quot;teacher is over&quot;);</span><br><span class="line">                    XposedBridge.log(&quot;teacher is overed&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 有参数的写法</span><br><span class="line">            XposedHelpers.findAndHookConstructor(myclass,int.class,String.class,boolean.class,new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.beforeHookedMethod(param);</span><br><span class="line">                    Object[] a &#x3D; param.args;  &#x2F;&#x2F; 获取构造参数</span><br><span class="line">                    a[0] &#x3D; 17;   &#x2F;&#x2F; 修改hook参数</span><br><span class="line">                    a[1] &#x3D; &quot;yuji&quot;;</span><br><span class="line">                    a[2] &#x3D; true;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.afterHookedMethod(param);</span><br><span class="line">                    Log.e(&quot;jrb1&quot;, &quot;teacher(17,&#39;yuji&#39;,true) is over&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="修改成员变量"><a href="#修改成员变量" class="headerlink" title="修改成员变量"></a>修改成员变量</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class myclass &#x3D; lpparam.classLoader.loadClass(&quot;com.jrb.mytest.teacher&quot;);</span><br><span class="line"></span><br><span class="line">XposedHelpers.findAndHookConstructor(&quot;com.jrb.mytest.teacher&quot;,lpparam.classLoader,new XC_MethodHook() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.beforeHookedMethod(param);</span><br><span class="line">        Method getString &#x3D; myclass.getDeclaredMethod(&quot;getString&quot;);</span><br><span class="line">        String str &#x3D; (String) getString.invoke(param.thisObject, null);</span><br><span class="line">        Log.e(&quot;jrb1&quot;, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.afterHookedMethod(param);</span><br><span class="line">        Log.e(&quot;jrb1&quot;, &quot;int to hook2&quot;);</span><br><span class="line">        Field age &#x3D; myclass.getDeclaredField(&quot;age&quot;);</span><br><span class="line">        age.set(param.thisObject, &quot;111&quot;);</span><br><span class="line">        </span><br><span class="line">        XposedHelpers.setStaticObjectField(myclass,&quot;name&quot;, &quot;test&quot;);</span><br><span class="line">        XposedHelpers.setStaticBooleanField(myclass,&quot;hair&quot;, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="hook-方法"><a href="#hook-方法" class="headerlink" title="hook 方法"></a>hook 方法</h4><pre><code><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(&quot;com.jrb.mytest.teacher$student&quot;, lpparam.classLoader, &quot;getString&quot;, new XC_MethodHook() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.beforeHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.afterHookedMethod(param);</span><br><span class="line">        String old_str &#x3D; (String) param.getResult();  &#x2F;&#x2F; 获得放回结果</span><br><span class="line">        Log.e(&quot;jrb1&quot;, old_str);</span><br><span class="line">        String str &#x3D; &quot;\narg:&quot;+&quot;88&quot;+&quot;  name:&quot;+&quot;QIMI&quot;+&quot;  hair:&quot;+&quot;true&quot; +&quot;\ncity:&quot;+&quot;HANGZHOU&quot;;</span><br><span class="line">        param.setResult(str);  &#x2F;&#x2F; 修改放回结果</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</code></pre><h4 id="主动调用static方法"><a href="#主动调用static方法" class="headerlink" title="主动调用static方法"></a>主动调用static方法</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 通过放射获取方法</span><br><span class="line">Class myclass &#x3D; lpparam.classLoader.loadClass(&quot;com.jrb.mytest.teacher&quot;);</span><br><span class="line">Method publicstaticmothod &#x3D; myclass.getDeclaredMethod(&quot;publicstaticmothod&quot;);</span><br><span class="line">String result &#x3D; (String) publicstaticmothod.invoke(null);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 通过xposed api 调用</span><br><span class="line">String result2 &#x3D; (String) XposedHelpers.callStaticMethod(myclass,&quot;publicstaticmothod&quot;);</span><br></pre></td></tr></table></figure>
<h4 id="publicmothod-privatemothod-寻找实例，主动调用"><a href="#publicmothod-privatemothod-寻找实例，主动调用" class="headerlink" title="publicmothod,privatemothod 寻找实例，主动调用"></a>publicmothod,privatemothod 寻找实例，主动调用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Log.e(&quot;jrb11&quot;,&quot;into hook&quot;);</span><br><span class="line">Class myclass &#x3D; lpparam.classLoader.loadClass(&quot;com.jrb.mytest.teacher&quot;);</span><br><span class="line"></span><br><span class="line">Object Obj &#x3D; myclass.newInstance();  &#x2F;&#x2F; 1.反射获取方法实例</span><br><span class="line">Constructor cons &#x3D; myclass.getConstructor(int.class);  &#x2F;&#x2F; 可以构造有参数的方法实例</span><br><span class="line">Object Obj2 &#x3D; cons.newInstance(1);</span><br><span class="line">Method publicmothod &#x3D; myclass.getDeclaredMethod(&quot;publicmothod&quot;);</span><br><span class="line"></span><br><span class="line">Object obj3 &#x3D; XposedHelpers.newInstance(myclass,1); &#x2F;&#x2F; 2.xposed api 获取方法实例</span><br><span class="line"></span><br><span class="line">String result &#x3D; (String) publicmothod.invoke(Obj);  &#x2F;&#x2F;1. 反射 调用</span><br><span class="line">Log.e(&quot;jrb11&quot; , result);</span><br><span class="line"></span><br><span class="line">String result2 &#x3D; (String) XposedHelpers.callMethod(Obj2,&quot;publicmothod&quot;); &#x2F;&#x2F; 2.xposed api 调用</span><br><span class="line">Log.e(&quot;jrb12&quot; , result2);</span><br><span class="line"></span><br><span class="line">String result3 &#x3D; (String) XposedHelpers.callMethod(obj3,&quot;privatemothod&quot;);</span><br><span class="line">Log.e(&quot;jrb13&quot;, result3);</span><br><span class="line"></span><br><span class="line">XposedHelpers.findAndHookConstructor(&quot;com.jrb.mytest.teacher&quot;, lpparam.classLoader,int.class, new XC_MethodHook() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.beforeHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.afterHookedMethod(param);</span><br><span class="line"></span><br><span class="line">        Method publicm &#x3D; myclass.getDeclaredMethod(&quot;publicmothod&quot;);</span><br><span class="line">        Method privatem &#x3D; myclass.getDeclaredMethod(&quot;privatemothod&quot;);</span><br><span class="line">        String result4 &#x3D; (String) publicm.invoke(param.thisObject);  &#x2F;&#x2F;3. hook Constructor 获取方法实例</span><br><span class="line">        privatem.setAccessible(true);</span><br><span class="line">        String result5 &#x3D; (String) privatem.invoke(param.thisObject);</span><br><span class="line">        Log.e(&quot;jrb14&quot; , result4);</span><br><span class="line">        Log.e(&quot;jrb15&quot; , result5);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">XposedHelpers.findAndHookMethod(myclass, &quot;getStr&quot;, myclass, new XC_MethodHook() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.beforeHookedMethod(param);</span><br><span class="line">        Method publicmd &#x3D; myclass.getDeclaredMethod(&quot;publicmothod&quot;);</span><br><span class="line">        String result6 &#x3D; (String) publicmd.invoke(param.args[0]);  &#x2F;&#x2F;4. hook mothod 参数</span><br><span class="line">        Log.e(&quot;jrb16&quot; , result6);</span><br><span class="line">        String result7 &#x3D; (String) XposedHelpers.callMethod(param.args[0],&quot;privatemothod&quot;);</span><br><span class="line"></span><br><span class="line">        Log.e(&quot;jrb17&quot; , result7);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">        super.afterHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>xposed</tag>
      </tags>
  </entry>
  <entry>
    <title>adb命令大全</title>
    <url>/2022/03/25/adb/</url>
    <content><![CDATA[<h3 id="adb命令大全"><a href="#adb命令大全" class="headerlink" title="adb命令大全"></a>adb命令大全</h3><h5 id="1、查询已连接设备-模拟器"><a href="#1、查询已连接设备-模拟器" class="headerlink" title="1、查询已连接设备/模拟器"></a>1、查询已连接设备/模拟器</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb devices</span><br></pre></td></tr></table></figure>
<h5 id="2、指定设备获取屏幕分辨率"><a href="#2、指定设备获取屏幕分辨率" class="headerlink" title="2、指定设备获取屏幕分辨率"></a>2、指定设备获取屏幕分辨率</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb -s 设备号 shell wm size</span><br></pre></td></tr></table></figure>
<h5 id="3、给指定设备安装应用"><a href="#3、给指定设备安装应用" class="headerlink" title="3、给指定设备安装应用"></a>3、给指定设备安装应用</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb -s 设备号 install test.apk</span><br></pre></td></tr></table></figure>
<h5 id="4、启动-adb-server-命令"><a href="#4、启动-adb-server-命令" class="headerlink" title="4、启动 adb server 命令"></a>4、启动 adb server 命令</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb start-server</span><br></pre></td></tr></table></figure>
<h5 id="5、停止-adb-server-命令"><a href="#5、停止-adb-server-命令" class="headerlink" title="5、停止 adb server 命令"></a>5、停止 adb server 命令</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb kill-server</span><br></pre></td></tr></table></figure>
<h5 id="6、查看adb版本"><a href="#6、查看adb版本" class="headerlink" title="6、查看adb版本"></a>6、查看adb版本</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb version</span><br></pre></td></tr></table></figure>
<h5 id="7、指定-adb-server-的网络端口"><a href="#7、指定-adb-server-的网络端口" class="headerlink" title="7、指定 adb server 的网络端口"></a>7、指定 adb server 的网络端口</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb -P &lt;port&gt; start-server</span><br></pre></td></tr></table></figure>
<h5 id="8、通过-IP-地址连接设备"><a href="#8、通过-IP-地址连接设备" class="headerlink" title="8、通过 IP 地址连接设备"></a>8、通过 IP 地址连接设备</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb connect &lt;device-ip-address&gt;</span><br></pre></td></tr></table></figure>
<h5 id="9、断开无线连接"><a href="#9、断开无线连接" class="headerlink" title="9、断开无线连接"></a>9、断开无线连接</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb disconnect &lt;device-ip-address&gt;</span><br></pre></td></tr></table></figure>
<h5 id="10、查看所有应用"><a href="#10、查看所有应用" class="headerlink" title="10、查看所有应用"></a>10、查看所有应用</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell pm list packages</span><br></pre></td></tr></table></figure>
<h5 id="11、查看系统应用"><a href="#11、查看系统应用" class="headerlink" title="11、查看系统应用"></a>11、查看系统应用</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell pm list packages -s</span><br></pre></td></tr></table></figure>
<h5 id="12、查看第三方应用"><a href="#12、查看第三方应用" class="headerlink" title="12、查看第三方应用"></a>12、查看第三方应用</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell pm list packages -3</span><br></pre></td></tr></table></figure>
<h5 id="13、卸载应用（-表示应用的包名，-k-参数可选，表示卸载应用但保留数据和缓存目录。）"><a href="#13、卸载应用（-表示应用的包名，-k-参数可选，表示卸载应用但保留数据和缓存目录。）" class="headerlink" title="13、卸载应用（ 表示应用的包名，-k 参数可选，表示卸载应用但保留数据和缓存目录。）"></a>13、卸载应用（<packagename> 表示应用的包名，-k 参数可选，表示卸载应用但保留数据和缓存目录。）</packagename></h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb uninstall [-k] &lt;packagename&gt;</span><br></pre></td></tr></table></figure>
<h5 id="14、清除应用数据与缓存"><a href="#14、清除应用数据与缓存" class="headerlink" title="14、清除应用数据与缓存"></a>14、清除应用数据与缓存</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell pm clear &lt;packagename&gt;</span><br></pre></td></tr></table></figure>
<h5 id="15、复制设备里的文件到电脑"><a href="#15、复制设备里的文件到电脑" class="headerlink" title="15、复制设备里的文件到电脑"></a>15、复制设备里的文件到电脑</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb pull &lt;设备里的文件路径&gt; [电脑上的目录]</span><br></pre></td></tr></table></figure>
<h5 id="16、复制电脑里的文件到设备"><a href="#16、复制电脑里的文件到设备" class="headerlink" title="16、复制电脑里的文件到设备"></a>16、复制电脑里的文件到设备</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push &lt;电脑上的文件路径&gt; &lt;设备里的目录&gt;</span><br></pre></td></tr></table></figure>
<h5 id="17、电源键"><a href="#17、电源键" class="headerlink" title="17、电源键"></a>17、电源键</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 26</span><br></pre></td></tr></table></figure>
<h5 id="18、菜单键"><a href="#18、菜单键" class="headerlink" title="18、菜单键"></a>18、菜单键</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 82</span><br></pre></td></tr></table></figure>
<h5 id="19、HOME-键"><a href="#19、HOME-键" class="headerlink" title="19、HOME 键"></a>19、HOME 键</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 3</span><br></pre></td></tr></table></figure>
<h5 id="20、返回键"><a href="#20、返回键" class="headerlink" title="20、返回键"></a>20、返回键</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 4</span><br></pre></td></tr></table></figure>
<h5 id="21、增加音量"><a href="#21、增加音量" class="headerlink" title="21、增加音量"></a>21、增加音量</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 24</span><br></pre></td></tr></table></figure>
<h5 id="22、降低音量"><a href="#22、降低音量" class="headerlink" title="22、降低音量"></a>22、降低音量</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 25</span><br></pre></td></tr></table></figure>
<h5 id="23、静音"><a href="#23、静音" class="headerlink" title="23、静音"></a>23、静音</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 164</span><br></pre></td></tr></table></figure>
<h5 id="24、播放-暂停"><a href="#24、播放-暂停" class="headerlink" title="24、播放/暂停"></a>24、播放/暂停</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 85</span><br></pre></td></tr></table></figure>
<h5 id="25、停止播放"><a href="#25、停止播放" class="headerlink" title="25、停止播放"></a>25、停止播放</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 86</span><br></pre></td></tr></table></figure>
<h5 id="26、播放下一首"><a href="#26、播放下一首" class="headerlink" title="26、播放下一首"></a>26、播放下一首</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 87</span><br></pre></td></tr></table></figure>
<h5 id="27、播放上一首"><a href="#27、播放上一首" class="headerlink" title="27、播放上一首"></a>27、播放上一首</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 88</span><br></pre></td></tr></table></figure>
<h5 id="28、恢复播放"><a href="#28、恢复播放" class="headerlink" title="28、恢复播放"></a>28、恢复播放</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 126</span><br></pre></td></tr></table></figure>
<h5 id="29、暂停播放"><a href="#29、暂停播放" class="headerlink" title="29、暂停播放"></a>29、暂停播放</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input keyevent 127</span><br></pre></td></tr></table></figure>
<h5 id="30、滑动解锁（参数-300-1000-300-500-分别表示起始点x坐标-起始点y坐标-结束点x坐标-结束点y坐标。）"><a href="#30、滑动解锁（参数-300-1000-300-500-分别表示起始点x坐标-起始点y坐标-结束点x坐标-结束点y坐标。）" class="headerlink" title="30、滑动解锁（参数 300 1000 300 500 分别表示起始点x坐标 起始点y坐标 结束点x坐标 结束点y坐标。）"></a>30、滑动解锁（参数 300 1000 300 500 分别表示起始点x坐标 起始点y坐标 结束点x坐标 结束点y坐标。）</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input swipe 300 1000 300 500</span><br></pre></td></tr></table></figure>
<h5 id="31、输入文本"><a href="#31、输入文本" class="headerlink" title="31、输入文本"></a>31、输入文本</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell input text hello</span><br></pre></td></tr></table></figure>
<h5 id="32、清空日志"><a href="#32、清空日志" class="headerlink" title="32、清空日志"></a>32、清空日志</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb logcat -c</span><br></pre></td></tr></table></figure>
<h5 id="33、查看设备型号"><a href="#33、查看设备型号" class="headerlink" title="33、查看设备型号"></a>33、查看设备型号</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell getprop ro.product.model</span><br></pre></td></tr></table></figure>
<h5 id="34、电池状况"><a href="#34、电池状况" class="headerlink" title="34、电池状况"></a>34、电池状况</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys battery</span><br></pre></td></tr></table></figure>
<h5 id="35、屏幕分辨率"><a href="#35、屏幕分辨率" class="headerlink" title="35、屏幕分辨率"></a>35、屏幕分辨率</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell wm size</span><br></pre></td></tr></table></figure>
<h5 id="36、屏幕密度"><a href="#36、屏幕密度" class="headerlink" title="36、屏幕密度"></a>36、屏幕密度</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell wm density</span><br></pre></td></tr></table></figure>
<h5 id="37、显示屏参数"><a href="#37、显示屏参数" class="headerlink" title="37、显示屏参数"></a>37、显示屏参数</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys window displays</span><br></pre></td></tr></table></figure>
<h5 id="38、查看Android-系统版本"><a href="#38、查看Android-系统版本" class="headerlink" title="38、查看Android 系统版本"></a>38、查看Android 系统版本</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell getprop ro.build.version.release</span><br></pre></td></tr></table></figure>
<h5 id="39、查看IP-地址"><a href="#39、查看IP-地址" class="headerlink" title="39、查看IP 地址"></a>39、查看IP 地址</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell ifconfig | grep Mask</span><br></pre></td></tr></table></figure>
<h5 id="40、Mac-地址"><a href="#40、Mac-地址" class="headerlink" title="40、Mac 地址"></a>40、Mac 地址</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell cat &#x2F;sys&#x2F;class&#x2F;net&#x2F;wlan0&#x2F;address</span><br></pre></td></tr></table></figure>
<h5 id="41、CPU-信息"><a href="#41、CPU-信息" class="headerlink" title="41、CPU 信息"></a>41、CPU 信息</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell cat &#x2F;proc&#x2F;cpuinfo</span><br></pre></td></tr></table></figure>
<h5 id="42、内存信息"><a href="#42、内存信息" class="headerlink" title="42、内存信息"></a>42、内存信息</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell cat &#x2F;proc&#x2F;meminfo</span><br></pre></td></tr></table></figure>
<h5 id="43、使用-Monkey-进行压力测试（表示向-指定的应用程序发送-500-个伪随机事件。）"><a href="#43、使用-Monkey-进行压力测试（表示向-指定的应用程序发送-500-个伪随机事件。）" class="headerlink" title="43、使用 Monkey 进行压力测试（表示向  指定的应用程序发送 500 个伪随机事件。）"></a>43、使用 Monkey 进行压力测试（表示向 <packagename> 指定的应用程序发送 500 个伪随机事件。）</packagename></h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell monkey -p &lt;packagename&gt; -v 500</span><br></pre></td></tr></table></figure>
<h5 id="44、查看进程"><a href="#44、查看进程" class="headerlink" title="44、查看进程"></a>44、查看进程</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell ps</span><br></pre></td></tr></table></figure>
<h5 id="45、查看实时资源占用情况"><a href="#45、查看实时资源占用情况" class="headerlink" title="45、查看实时资源占用情况"></a>45、查看实时资源占用情况</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell top</span><br></pre></td></tr></table></figure>
<h5 id="46、强制安装-指定版本"><a href="#46、强制安装-指定版本" class="headerlink" title="46、强制安装 指定版本"></a>46、强制安装 指定版本</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb install -r -t --abi armeabi-v7a aaa.apk</span><br></pre></td></tr></table></figure>
<h5 id="47、查看前台的类"><a href="#47、查看前台的类" class="headerlink" title="47、查看前台的类"></a>47、查看前台的类</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys window | grep mCurrentFocus</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>adb</tag>
      </tags>
  </entry>
  <entry>
    <title>frida 环境</title>
    <url>/2022/03/26/frida_env/</url>
    <content><![CDATA[<h3 id="frida-kali环境配置"><a href="#frida-kali环境配置" class="headerlink" title="frida,kali环境配置"></a>frida,kali环境配置</h3><p>kali-linux-2021-1的地址<a href="https://pan.baidu.com/s/1dPIe5FzZLQzSLMsMcGZUrg" target="_blank" rel="noopener">百度云盘</a>  提取码：50jw </p>
<h4 id="1-切换root登录"><a href="#1-切换root登录" class="headerlink" title="1.切换root登录"></a>1.切换root登录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一次登录利用 kali  kali</span><br><span class="line">在Terminal输入 </span><br><span class="line">    sudo passwd root</span><br><span class="line">    password for kali: kali</span><br><span class="line">    New password: toor</span><br><span class="line">    Retype new password: toor</span><br><span class="line">出现passwd: password updated successfully表示成功</span><br><span class="line">重启虚拟机就可以 root toor 登录</span><br><span class="line"></span><br><span class="line">退回bash</span><br><span class="line">chsh -s &#x2F;bin&#x2F;bash</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h4 id="2-kali的一些修复操作"><a href="#2-kali的一些修复操作" class="headerlink" title="2.kali的一些修复操作"></a>2.kali的一些修复操作</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.修复时区</span><br><span class="line">dpkg-reconfigure tzdata</span><br><span class="line">然后选择 Asia→Shanghai</span><br><span class="line"></span><br><span class="line">2.安装一些常用工具</span><br><span class="line">apt update</span><br><span class="line">apt install tmux htop tree jnettop neofetch</span><br><span class="line"></span><br><span class="line">3.更变日志大小</span><br><span class="line">nano .bashrc</span><br><span class="line">HISTSIZE&#x3D;1000000</span><br><span class="line">HISTFILESIZE&#x3D;2000000</span><br><span class="line">source .bashrc</span><br></pre></td></tr></table></figure>
<h4 id="3-proxychains4代理设置"><a href="#3-proxychains4代理设置" class="headerlink" title="3.proxychains4代理设置"></a>3.proxychains4代理设置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nano &#x2F;etc&#x2F;proxychains4.conf </span><br><span class="line">注释 proxy_dns</span><br><span class="line">注释 scok4 127.0.0.1 9050</span><br><span class="line">添加 scok5 192.168.1.100 1080</span><br><span class="line">proxychains curl ip.sb</span><br></pre></td></tr></table></figure>
<h4 id="4-redsocks全局代理设置参考文章"><a href="#4-redsocks全局代理设置参考文章" class="headerlink" title="4.redsocks全局代理设置参考文章"></a>4.redsocks全局代理设置<a href="https://cnblogs.com/volqiu/p/4811402.html" target="_blank" rel="noopener">参考文章</a></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nano redsocks.conf</span><br><span class="line">设置ip和电脑ip相同   ip &#x3D; 192.168.1.135;</span><br><span class="line">启动 redsocks</span><br><span class="line">查看进程  ps aux |grep redsocks</span><br><span class="line">查看监听端口 ss -lntp|more</span><br><span class="line">最后运行代码  sh iptables.sh</span><br></pre></td></tr></table></figure>
<p>iptables.sh</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#不重定向目的地址为服务器的包</span><br><span class="line">iptables -t nat -A OUTPUT -d 192.168.179.1 -j RETURN  #请用你的shadowsocks服务器的地址替换$SERVER_IP</span><br><span class="line"> </span><br><span class="line">#不重定向私有地址的流量</span><br><span class="line">iptables -t nat -A OUTPUT -d 10.0.0.0&#x2F;8 -j RETURN</span><br><span class="line">iptables -t nat -A OUTPUT -d 172.16.0.0&#x2F;16 -j RETURN</span><br><span class="line">iptables -t nat -A OUTPUT -d 192.168.0.0&#x2F;16 -j RETURN</span><br><span class="line"> </span><br><span class="line">#不重定向保留地址的流量,这一步很重要</span><br><span class="line">iptables -t nat -A OUTPUT -d 127.0.0.0&#x2F;8 -j RETURN</span><br><span class="line"> </span><br><span class="line">#重定向所有不满足以上条件的流量到redsocks监听的12345端口</span><br><span class="line">iptables -t nat -A OUTPUT -p tcp -j REDIRECT --to-ports 12345 #12345是你的redsocks运行的端口,请根据你的情况替换它</span><br></pre></td></tr></table></figure>
<h4 id="去缓存"><a href="#去缓存" class="headerlink" title="去缓存"></a>去缓存</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;.cache&#x2F;vmware</span><br><span class="line">rm -rf *</span><br></pre></td></tr></table></figure>
<h4 id="5-一些工具的安装"><a href="#5-一些工具的安装" class="headerlink" title="5.一些工具的安装"></a>5.一些工具的安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.安装AS</span><br><span class="line">wget https:&#x2F;&#x2F;redirector.gvt1.com&#x2F;edgedl&#x2F;android&#x2F;studio&#x2F;ide-zips&#x2F;4.1.2.0&#x2F;android-studio-ide-201.7042882-linux.tar.gz</span><br><span class="line">tar zxvf android-studio-ide-201.7042882-linux.tar.gz</span><br><span class="line"></span><br><span class="line">设置adb 系统变量</span><br><span class="line">nano ~&#x2F;.bashrc</span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;root&#x2F;Android&#x2F;Sdk&#x2F;platform-tools</span><br><span class="line">source ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">2.安装jdax</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;skylot&#x2F;jadx&#x2F;releases&#x2F;download&#x2F;v1.2.0&#x2F;jadx-1.2.0.zip</span><br><span class="line">mkdir jadx</span><br><span class="line">mv jadx-1.2.0.zip jadx</span><br><span class="line">cd jadx</span><br><span class="line">7z x jadx-1.2.0.zip </span><br><span class="line"></span><br><span class="line">3.安装010</span><br><span class="line">https:&#x2F;&#x2F;www.sweetscape.com&#x2F;download&#x2F;010editor&#x2F;download_010editor_linux64.html</span><br><span class="line">tar zxvf 010EditorLinux64Installer11.0.1.tar.gz </span><br><span class="line">.&#x2F;010EditorLinux64Installer </span><br><span class="line"></span><br><span class="line">4.安装vs</span><br><span class="line">https:&#x2F;&#x2F;code.visualstudio.com&#x2F; 下载deb 版本</span><br><span class="line">dpkg -i code_1.53.2-1613044664_amd64.deb</span><br><span class="line"></span><br><span class="line">5.安装jeb</span><br><span class="line">7z x jeb-pro-3.19.1.202005071620_pwd_ilbtcdnwiuypbzeo_sn_#61641164873316763_.zip</span><br><span class="line">.&#x2F;jeb_linux.sh</span><br><span class="line">输入密码  ilbtcdnwiuypbzeo</span><br><span class="line">python jebKeygen.py （python2）</span><br><span class="line">JEB License Key: xxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">6.Kali Linux里的as4的DDMS启动失败，原因是要用as自带的jre来启动，直接.&#x2F;monitor用的是Kali系统的jdk，版本太高了：</span><br><span class="line"># ln -s  &#x2F;root&#x2F;Desktop&#x2F;android-studio&#x2F;jre&#x2F; &#x2F;root&#x2F;Android&#x2F;Sdk&#x2F;tools[表情]b&#x2F;monitor-x86_64&#x2F;</span><br></pre></td></tr></table></figure>
<h4 id="6-安装pyenv"><a href="#6-安装pyenv" class="headerlink" title="6.安装pyenv"></a>6.安装pyenv</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;pyenv&#x2F;pyenv.git ~&#x2F;.pyenv</span><br><span class="line">echo &#39;export PYENV_ROOT&#x3D;&quot;$HOME&#x2F;.pyenv&quot;&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line">echo &#39;export PATH&#x3D;&quot;$PYENV_ROOT&#x2F;bin:$PATH&quot;&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line">echo -e &#39;if command -v pyenv 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init -)&quot;\nfi&#39; &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line">exec &quot;$SHELL&quot;</span><br><span class="line">sudo apt-get update; sudo apt-get install --no-install-recommends make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev</span><br><span class="line">source ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">安装python:  pyenv install 3.8.0</span><br><span class="line">切换python:  pyenv local 3.8.0</span><br><span class="line">查看系统所有python版本:  pyenv versions</span><br><span class="line">查看系统当前使用:   python pyenv version</span><br></pre></td></tr></table></figure>
<h4 id="7-安装frida环境"><a href="#7-安装frida环境" class="headerlink" title="7.安装frida环境"></a>7.安装<a href="https://github.com/frida/frida" target="_blank" rel="noopener">frida</a>环境</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">安装3.8.0特定版本</span><br><span class="line">pip install frida&#x3D;&#x3D;12.8.0</span><br><span class="line">pip install frida-tools&#x3D;&#x3D;5.3.0</span><br><span class="line">pip install objection&#x3D;&#x3D;1.8.4</span><br><span class="line"></span><br><span class="line">普通下载</span><br><span class="line">pip install frida-tool</span><br><span class="line">pip install objection</span><br><span class="line"></span><br><span class="line">安装node</span><br><span class="line">apt-get install -y nodejs</span><br><span class="line">apt-get install npm</span><br><span class="line"></span><br><span class="line">js环境 </span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;oleavr&#x2F;frida-agent-example.git</span><br><span class="line">cd frida-agent-example&#x2F;</span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">手机frida-server安装</span><br><span class="line">adb push frida-server-12.8.0-android-arm64 &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line"></span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">cd &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">chmod 777 frida-server-12.8.0-android-arm64 </span><br><span class="line">.&#x2F;frida-server-12.8.0-android-arm64</span><br><span class="line"></span><br><span class="line">监听端口</span><br><span class="line">.&#x2F;frida-server-12.8.0-android-arm64 -l 0.0.0.0:8888</span><br><span class="line"></span><br><span class="line">js frida运行js脚本</span><br><span class="line">frida -U -f com.example.android --no-pause -l s1.js</span><br><span class="line"></span><br><span class="line">SPAWN：创建进程时就hook：有壳的话就不行</span><br><span class="line">frida -U -f com.example.demo s1.js --no-pause </span><br><span class="line">ATTACH：应用运行过程中hook：有壳也是ok</span><br><span class="line">frida -UF -l s1.js</span><br><span class="line"></span><br><span class="line">frida-ps -U 查看通过usb连接的android手机上的进程</span><br><span class="line">frida -H 192.168.1.8:8888 -f com.android.settings  查看通过端口连接的android手机上的进程</span><br><span class="line">在系统里装上这个这个npm包，可以在任意工程获得frida的代码提示、补全和API查看</span><br><span class="line">npm install --save @types&#x2F;frida-gum</span><br></pre></td></tr></table></figure>
<h3 id="Frida-rpc"><a href="#Frida-rpc" class="headerlink" title="Frida rpc"></a>Frida rpc</h3><h4 id="例子一：-send-recv"><a href="#例子一：-send-recv" class="headerlink" title="例子一： send recv"></a>例子一： send recv</h4><p>java 代码： 输入 username 和 password  然后进行base64编码输出<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.findViewById(R.id.button).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username_et.getText().toString().compareTo(<span class="string">"admin"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            message_tv.setText(<span class="string">"You cannot login as admin"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//hook target</span></span><br><span class="line">        message_tv.setText(<span class="string">"Sending to the server :"</span> + Base64.encodeToString((username_et.getText().toString() + <span class="string">":"</span> + password_et.getText().toString()).getBytes(), Base64.DEFAULT));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><br><img src="/2022/03/26/frida_env/7_1.png" alt="app"></p>
<p>js hook 代码 t1.js<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"android.widget.TextView"</span>).setText.overload(<span class="string">'java.lang.CharSequence'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> string_to_send_x = x.toString();</span><br><span class="line">            <span class="keyword">var</span> string_to_recv;</span><br><span class="line">            send(string_to_send_x); <span class="comment">// 将数据输出过去</span></span><br><span class="line">            recv(<span class="function"><span class="keyword">function</span>(<span class="params">received_json_objection</span>)</span>&#123;  <span class="comment">// 接收放回的数据</span></span><br><span class="line">                string_to_recv = received_json_objection.my_data;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"string_to_recv:"</span>+string_to_recv)</span><br><span class="line">            &#125;).wait();</span><br><span class="line">            <span class="keyword">var</span> javaStringToSend=Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(string_to_recv);  <span class="comment">// 转成java的字符串</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.setText(javaStringToSend);  <span class="comment">// 修改放回值</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x.toString(),result"</span>,javaStringToSend.toString(),result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><br>python 代码<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message,payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line">    <span class="comment"># 处理 send 函数传回的数据</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"type"</span>]==<span class="string">"send"</span>:</span><br><span class="line">        print(message[<span class="string">"payload"</span>])</span><br><span class="line">        data = message[<span class="string">"payload"</span>].split(<span class="string">":"</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        print(<span class="string">'message:'</span>,message)</span><br><span class="line">        data = str(base64.b64decode(data))</span><br><span class="line">        print(<span class="string">'data:'</span>,data)</span><br><span class="line">        usr,pw = data.split(<span class="string">":"</span>)</span><br><span class="line">        print(<span class="string">'pw:'</span>,pw)</span><br><span class="line">        data = str(base64.b64encode((<span class="string">"admin"</span>+<span class="string">":"</span>+pw).encode()))</span><br><span class="line">        print(<span class="string">"encode data:"</span>,data)</span><br><span class="line">        script.post(&#123;<span class="string">"my_data"</span>:data&#125;)  <span class="comment"># 传回修改好的数据</span></span><br><span class="line">        print(<span class="string">"Modified data sent !"</span>)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()  <span class="comment">#连接 adb</span></span><br><span class="line">session = device.attach(<span class="string">"com.example.lesson7sec"</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"t1.js"</span>) <span class="keyword">as</span> f :</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">"message"</span>,my_message_handler)</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure></p>
<h4 id="例子二：-rpc"><a href="#例子二：-rpc" class="headerlink" title="例子二： rpc"></a>例子二： rpc</h4><p>js hook t2.js<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"com.example.lesson4one.MainActivity"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"found instance :"</span>,instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"found instance :"</span>,instance.secret())</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    invokefunc:invoke</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>python 调用代码</p>
<h2 id><a href="#" class="headerlink" title></a><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message,payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#device = frida.get_usb_device()</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">"192.168.1.102:9999"</span>) <span class="comment"># 端口调用</span></span><br><span class="line"><span class="comment">#pid = device.spawn(["com.example.lesson4one"]) # span 加载</span></span><br><span class="line"><span class="comment">#session = device.attach(pid)</span></span><br><span class="line">session = device.attach(<span class="string">"com.example.lesson4one"</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"t2.js"</span>) <span class="keyword">as</span> f :</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">"message"</span>,my_message_handler)  <span class="comment"># 注册错误处理回调</span></span><br><span class="line">script.load()</span><br><span class="line"><span class="comment"># rpc 调用</span></span><br><span class="line">script.exports.invokefunc()</span><br></pre></td></tr></table></figure></h2><h3 id="远程调用-nps-端口转发"><a href="#远程调用-nps-端口转发" class="headerlink" title="远程调用 nps 端口转发"></a>远程调用 <a href="https://github.com/ehang-io/nps" target="_blank" rel="noopener">nps</a> 端口转发</h3><p>服务端和客户端 可参考 <a href="https://github.com/ehang-io/nps/blob/master/README_zh.md" target="_blank" rel="noopener">README 文档</a></p>
<p>pc 客户端 配置 </p>
<p><img src="/2022/03/26/frida_env/nps_1.png" alt="app"></p>
<p>服务端 执行客户端的 客户端命令：./npc -server={ip}:{port} -vkey={key} -type=tcp</p>
<p><img src="/2022/03/26/frida_env/nps_2.png" alt="app"></p>
<p>配置对应的tcp  记得linux 端口 要开放</p>
<p><img src="/2022/03/26/frida_env/nps_3.png" alt="app"></p>
<p>代码 修改 连接 linux 服务器的地址</p>
<p><img src="/2022/03/26/frida_env/nps_4.png" alt="app"></p>
<h3 id="frida-打印-构造数组-对象，Map-类和参数"><a href="#frida-打印-构造数组-对象，Map-类和参数" class="headerlink" title="frida 打印 构造数组,对象，Map,类和参数"></a>frida 打印 构造数组,对象，Map,类和参数</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.openClassFile(<span class="string">"/data/local/tmp/r0gson.dex"</span>).load();</span><br><span class="line">        <span class="keyword">const</span> gson = Java.use(<span class="string">'com.r0ysue.gson.Gson'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主动hook java.lang.Character  打印参数，返回值，修改返回值</span></span><br><span class="line">        Java.use(<span class="string">"java.lang.Character"</span>).toString.overload(<span class="string">'char'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(x);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x,result"</span>,x,result);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"对象数组"</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 重载, 构造Arrays, gson 打印Arrays, 修改返回值</span></span><br><span class="line">        Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">arg1</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> charArray = Java.array(<span class="string">'char'</span>, [ <span class="string">'一'</span>,<span class="string">'去'</span>,<span class="string">'二'</span>,<span class="string">'三'</span>,<span class="string">'里'</span> ]);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(charArray);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"arg1"</span>,gson.$<span class="keyword">new</span>().toJson(arg1));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x,result"</span>,gson.$<span class="keyword">new</span>().toJson(charArray),result);</span><br><span class="line">            <span class="keyword">return</span> Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(Java.array(<span class="string">'char'</span>,[<span class="string">'烟'</span>,<span class="string">'村'</span>,<span class="string">'四'</span>,<span class="string">'五'</span>,<span class="string">'家'</span>]));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[B'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(x);</span><br><span class="line">            <span class="comment">// console.log("x,result",gson.$new().toJson(x),result);            </span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x,result"</span>,x,result);            </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 在内存中在实例，调用实例的动态方法， 子类向父类转型</span></span><br><span class="line">        <span class="keyword">var</span> JuiceHandle = <span class="literal">null</span> ;</span><br><span class="line">        Java.choose(<span class="string">"com.r0ysue.a0526printout.Juice"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"found instance :"</span>,instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"filling energy,"</span>,instance.fillEnergy());</span><br><span class="line">                JuiceHandle= instance;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="string">"Search Completed!"</span>&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">var</span> WaterHandle = Java.cast(JuiceHandle ,Java.use(<span class="string">"com.r0ysue.a0526printout.Water"</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Water invoke still "</span>, WaterHandle.still(WaterHandle));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造类,方法, 主动调用</span></span><br><span class="line">        <span class="keyword">var</span> beer = Java.registerClass(&#123;</span><br><span class="line">            name: <span class="string">'com.r0ysue.a0526printout.beer'</span>,</span><br><span class="line">            implements: [Java.use(<span class="string">'com.r0ysue.a0526printout.liquid'</span>)],</span><br><span class="line">            methods: &#123;</span><br><span class="line">                flow: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"look I`m beer!"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"taste good!"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"beer.flow:"</span>,beer.$<span class="keyword">new</span>().flow());  </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 枚举打印hashmap,  hook 打印hashmap</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hashmap888</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"java.util.HashMap"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance.toString().indexOf(<span class="string">"ISBN"</span>)!=<span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"found HashMap"</span>,instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"HashMap toString:"</span>,instance.toString());</span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">"Search Completed!"</span>)&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        Java.use(<span class="string">"java.util.HashMap"</span>).put.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.put(x,y);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x,y,result"</span>,x,y,result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 打印obj</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jhexdump</span>(<span class="params">array,off,len</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ptr = Memory.alloc(len-off);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = off; i &lt; len; ++i)</span><br><span class="line">        Memory.writeS8(ptr.add(i), array[i]);</span><br><span class="line">    <span class="built_in">console</span>.log(hexdump(ptr, &#123; <span class="attr">offset</span>: off, <span class="attr">length</span>: len, <span class="attr">header</span>: <span class="literal">false</span>, <span class="attr">ansi</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实例App-KGB"><a href="#实例App-KGB" class="headerlink" title="实例App KGB"></a>实例App KGB</h3><p>我们打开app 时会遇到拦截,通过提示在jadx 中搜索</p>
<p><img src="/2022/03/26/frida_env/kgb1.png" alt="kgb"></p>
<p>定位拦截代码</p>
<p><img src="/2022/03/26/frida_env/kgb2.png" alt="kgb"></p>
<p>res/values/strings.xml</p>
<p><img src="/2022/03/26/frida_env/kgb3.png" alt="kgb"></p>
<p>js hook<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.use(<span class="string">"java.lang.System"</span>).getProperty.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.getProperty(x);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x,result:"</span>,x,result);</span><br><span class="line">            <span class="keyword">return</span> Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(<span class="string">"Russia"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">Java.use(<span class="string">"java.lang.System"</span>).getenv.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.getenv(x);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"x,result:"</span>,x,result);</span><br><span class="line">    <span class="keyword">return</span> Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(<span class="string">"RkxBR3s1N0VSTDFOR180UkNIM1J9Cg=="</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>登录 username:codenameduchess  84e343a0486ff05530df6c705c8bb4  passward:guest login代码</p>
<p><img src="/2022/03/26/frida_env/kgb4.png" alt="kgb"></p>
<p>Messenger 代码</p>
<p><img src="/2022/03/26/frida_env/kgb7.png" alt="kgb"></p>
<p>java a 函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] charArray = str.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charArray.length / <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> c = charArray[i];</span><br><span class="line">            charArray[i] = (<span class="keyword">char</span>) (charArray[(charArray.length - i) - <span class="number">1</span>] ^ <span class="string">'2'</span>);</span><br><span class="line">            charArray[(charArray.length - i) - <span class="number">1</span>] = (<span class="keyword">char</span>) (c ^ <span class="string">'A'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(charArray);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>创建android studio项目 新建类reverseA.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 反解p输入的内容</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decode_p</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String p = <span class="string">"V@]EAASB\u0012WZF\u0012e,a$7(&amp;am2(3.\u0003"</span>;</span><br><span class="line">    String result = a(p);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] charArray = str.toCharArray();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charArray.length / <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = charArray[i];</span><br><span class="line">        charArray[i] = (<span class="keyword">char</span>) (charArray[(charArray.length - i) - <span class="number">1</span>] ^ <span class="string">'A'</span>);</span><br><span class="line">        charArray[(charArray.length - i) - <span class="number">1</span>] = (<span class="keyword">char</span>) (c ^ <span class="string">'2'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(charArray);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将不规则字符转成hex</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">r_to_hex</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String r = <span class="string">"\u0000dslp&#125;oQ\u0000 dks$|M\u0000h +AYQg\u0000P*!M$gQ\u0000"</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = r.getBytes();</span><br><span class="line">    String result = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;bytes.length;i++)&#123;</span><br><span class="line">        result+=String.format(<span class="string">"%02x"</span>,bytes[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译 拿出 classes.dex, 然后push到手机上,记得给权限 chmod 777 classes.dex</p>
<p>js hook<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">"/data/local/tmp/classes.dex"</span>).load();</span><br><span class="line"><span class="keyword">const</span> reverseA = Java.use(<span class="string">'com.jrb.kgb.reverseA'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"reverseA result:"</span>,reverseA.decode_p()); <span class="comment">// Boris, give me the password</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"r_to_hex result:"</span>,reverseA.r_to_hex()); <span class="comment">// 0064736c707d6f510020646b73247c4d0068202b4159516700502a214d24675100</span></span><br></pre></td></tr></table></figure><br><img src="/2022/03/26/frida_env/kgb6.png" alt="kgb"></p>
<p>z3 的使用,反解b函数 pip install z3-solver(代码有误)<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">from binascii import b2a_hex,a2b_hex</span><br><span class="line"></span><br><span class="line">s &#x3D;Solver()</span><br><span class="line">r &#x3D; &quot;0064736c707d6f510020646b73247c4d0068202b4159516700502a214d24675100&quot;</span><br><span class="line"></span><br><span class="line">r_result &#x3D; bytearray(a2b_hex(r))</span><br><span class="line">print(r_result)</span><br><span class="line">for i in range(int(len(r_result)&#x2F;2)) :</span><br><span class="line">    c &#x3D; r_result[i]</span><br><span class="line">    r_result[i] &#x3D; r_result[len(r_result)-i-1]</span><br><span class="line">    r_result[len(r_result)-i-1] &#x3D; c</span><br><span class="line">print(b2a_hex(r_result))</span><br><span class="line"></span><br><span class="line">x &#x3D; [BitVec(&quot;x%s&quot; % i, 32) for i in range(len(r_result))]</span><br><span class="line">for i in range(len(r_result)):</span><br><span class="line">    c &#x3D; r_result[i]</span><br><span class="line">    print(i,hex(c))</span><br><span class="line">    s.add(((x[i] &gt;&gt; (i % 8)) ^ x[i] ) &#x3D;&#x3D; r_result[i])</span><br><span class="line">if (s.check() &#x3D;&#x3D; sat):</span><br><span class="line">    model &#x3D; s.model()</span><br><span class="line">    print(model)</span><br><span class="line">    flag&#x3D;&quot;&quot;</span><br><span class="line">    for i in range(len(r_result)):</span><br><span class="line">        if (model[x[i]] !&#x3D; None):</span><br><span class="line">            flag +&#x3D; chr(model[x[i]].as_long().real)</span><br><span class="line">        else:</span><br><span class="line">            flag +&#x3D; &quot; &quot;</span><br><span class="line">    print(&#39;&quot;&#39; + flag + &#39;&quot;&#39;)</span><br><span class="line">    print(len(flag), len(r_result))</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>kali</tag>
      </tags>
  </entry>
  <entry>
    <title>Android逆向之某狗signature</title>
    <url>/2022/03/29/kugou/</url>
    <content><![CDATA[<h3 id="Android逆向之某狗signature"><a href="#Android逆向之某狗signature" class="headerlink" title="Android逆向之某狗signature"></a>Android逆向之某狗signature</h3><h4 id="抓包-charles-vpn"><a href="#抓包-charles-vpn" class="headerlink" title="抓包 charles + vpn"></a>抓包 charles + vpn</h4><p>app version 11.1.4</p>
<p>今天我们分析一个简单的app的signature,首先先抓包</p>
<p><img src="/2022/03/29/kugou/1.png" alt="抓包"></p>
<p>利用反编译工具，搜索”signature”</p>
<p><img src="/2022/03/29/kugou/2.png" alt="jadx"></p>
<p>经过跟踪定位,我们猜测com.kugou.common.utils.ba是加密类</p>
<p><img src="/2022/03/29/kugou/3.png" alt="jadx"></p>
<p>接下来进行frida hook</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> signatureCls = Java.use(<span class="string">'com.kugou.common.utils.ba'</span>);</span><br><span class="line">		signatureCls.b.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str1</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> result = <span class="keyword">this</span>.b(str1);</span><br><span class="line">	        <span class="built_in">console</span>.log(<span class="string">"&gt;&gt;&gt; signature inStr  = "</span> + str1);</span><br><span class="line">		    <span class="built_in">console</span>.log(<span class="string">" &gt;&gt;&gt;  signature rc= "</span> + result);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/29/kugou/4.png" alt="hook"></p>
<p>将抓包结果 利用postman发请求 Copy cURL Reuqest</p>
<p><img src="/2022/03/29/kugou/5.png" alt="hook"><br><img src="/2022/03/29/kugou/6.png" alt="hook"></p>
<p>不难发现 我signture 的加密函数就是 我们 请求参数排序 加 盐  md5加密</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">"http://m.comment.service.kugou.com/v1/cmtlist?"</span></span><br><span class="line">salt = <span class="string">'OIlwieks28dk2k092lksi2UIkp'</span></span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">'ver'</span>: <span class="string">'10'</span>,</span><br><span class="line">    <span class="string">'code'</span>: <span class="string">'fc4be23b4e972707f36b8a828a93ba8a'</span>,</span><br><span class="line">    <span class="string">'clienttoken'</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">'area_code'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'extdata'</span>: <span class="string">'88b790d52570772c3a8b830c0b9b9236'</span>,</span><br><span class="line">    <span class="string">'mid'</span>: <span class="string">'317888404353155346828797154789613205939'</span>,</span><br><span class="line">    <span class="string">'uuid'</span>: <span class="string">'136f14e8929164da7fd59d45a78b65fa'</span>,</span><br><span class="line">    <span class="string">'p'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'dfid'</span>: <span class="string">'0QbvHC39mPM23Ewcap3wo8d1'</span>,</span><br><span class="line">    <span class="string">'show_star_cmts'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'appid'</span>: <span class="string">'1005'</span>,</span><br><span class="line">    <span class="string">'is_show_hot_word'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'pagesize'</span>: <span class="string">'20'</span>,</span><br><span class="line">    <span class="string">'show_classify'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'clientver'</span>: <span class="string">'11145'</span>,</span><br><span class="line">    <span class="string">'tag'</span>: <span class="string">'5'</span>,</span><br><span class="line">    <span class="string">'clienttime'</span>: str(int(time.time())),</span><br><span class="line">    <span class="string">'gitversion'</span>: <span class="string">'bf61921'</span>,</span><br><span class="line">    <span class="string">'kugouid'</span>: <span class="string">'0'</span>,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 按照 key 排序</span></span><br><span class="line">post_data = collections.OrderedDict(</span><br><span class="line">    sorted(params.items(),</span><br><span class="line">           key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line">)</span><br><span class="line">sortStr = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> post_data.items():</span><br><span class="line">    sortStr += k + <span class="string">'='</span> + v</span><br><span class="line">payload=<span class="string">"&#123;\"read_ids\":\"714022189,602347340,609481236\"&#125;"</span></span><br><span class="line"></span><br><span class="line">endstr = salt + sortStr + payload + salt</span><br><span class="line">print(endstr)</span><br><span class="line">m = hashlib.md5()</span><br><span class="line">m.update(endstr.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">signature = m.hexdigest()</span><br><span class="line"></span><br><span class="line">print(signature)</span><br><span class="line">params[<span class="string">'signature'</span>] = signature</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">  <span class="string">'KG-THash'</span>: <span class="string">'690978f'</span>,</span><br><span class="line">  <span class="string">'User-Agent'</span>: <span class="string">'Android810-AndroidPhone-11145-56-0-COMMENT-wifi'</span>,</span><br><span class="line">  <span class="string">'KG-RC'</span>: <span class="string">'4'</span>,</span><br><span class="line">  <span class="string">'KG-FAKE'</span>: <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">'KG-RF'</span>: <span class="string">'00984990'</span>,</span><br><span class="line">  <span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">  <span class="string">'Host'</span>: <span class="string">'m.comment.service.kugou.com'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, headers=headers, params= params, data=payload)</span><br><span class="line"></span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>frida hook java 基础六层锁机</title>
    <url>/2022/03/23/frida_hook_java/</url>
    <content><![CDATA[<h3 id="六层锁机"><a href="#六层锁机" class="headerlink" title="六层锁机"></a>六层锁机</h3><h4 id="登录页"><a href="#登录页" class="headerlink" title="登录页"></a>登录页</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">打开app, 随意输入登录，根据页面提示 利用jadx搜索Login failed</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/frida_hook_java/6login.png" alt="jadx 搜索"><br><img src="/2022/03/23/frida_hook_java/6_login.png" alt="登录代码"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态分析jadx反编译代码  主要 需要com.example.androiddemo.Activity.LoginActivity.a 方法和 密码相同</span><br><span class="line">下面 编写 frida 脚本 主动调用java函数 打印结果</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.LoginActivity"</span>).a.overload(<span class="string">'java.lang.String'</span>, <span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.a(x,y);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"x y result"</span>, x ,y ,result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/frida_hook_java/6_login1.png" alt="结果"><br><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 利用adb在页面焦点输入内容  username aaaa password  bb9d9016b60ef5ebe72e859d5a5f630c62fff00571361998267a3f6d7c12e482</span></span><br><span class="line">adb shell</span><br><span class="line">input text bb9d9016b60ef5ebe72e859d5a5f630c62fff00571361998267a3f6d7c12e482</span><br></pre></td></tr></table></figure></p>
<h4 id="第一关"><a href="#第一关" class="headerlink" title="第一关"></a>第一关</h4><p><img src="/2022/03/23/frida_hook_java/6_1.png" alt="第一关"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态分析jadx反编译代码  需要 a 函数的返回结果等于 R4jSLLLLLLLLLLOrLE7&#x2F;5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL&#x3D;</span><br><span class="line">下面 编写 frida 脚本 主动修改a函数的返回值</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity1"</span>).a.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL="</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第二关"><a href="#第二关" class="headerlink" title="第二关"></a>第二关</h4><p><img src="/2022/03/23/frida_hook_java/6_2.png" alt="第二关"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态分析jadx反编译代码 static_bool_var 和 bool_var 都要为 true,实例方法 setBool_var ，静态方法 setStatic_bool_var</span><br><span class="line">下面 编写 frida 脚本 主动调用动态函数 需要在 Java.choose 中调用，静态函数直接调用</span><br></pre></td></tr></table></figure><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity2"</span>).setStatic_bool_var();</span><br><span class="line">        Java.choose(<span class="string">"com.example.androiddemo.Activity.FridaActivity2"</span>,&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance"</span>, instance);</span><br><span class="line">                instance.setBool_var();</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search complete!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="第三关"><a href="#第三关" class="headerlink" title="第三关"></a>第三关</h4><p><img src="/2022/03/23/frida_hook_java/6_3.png" alt="第三关"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态分析jadx反编译代码 static_bool_var 和 bool_var console.log 都要为 true</span><br><span class="line">下面 编写 frida 脚本 主动调用修改实例成员变量，静态成员变量  ps(成员变量和函数名称一样是，成员变量前需要加_)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>).static_bool_var.value = <span class="literal">true</span> ;</span><br><span class="line"></span><br><span class="line">        Java.choose(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>,&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance"</span>, instance);</span><br><span class="line">                instance.bool_var.value = <span class="literal">true</span>;</span><br><span class="line">                instance._same_name_bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search complete!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第四关"><a href="#第四关" class="headerlink" title="第四关"></a>第四关</h4><p><img src="/2022/03/23/frida_hook_java/6_4.png" alt="第四关"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">内部类 需要$来表示   InnerClass.class.getDeclaredMethods() 枚举所有的方法</span><br></pre></td></tr></table></figure><br>，枚举类的函数并hook(getDeclaredMethods)<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 普通解法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_4</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check1.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check2.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check3.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check4.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check5.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>).check6.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 枚举法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_42</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> class_name = <span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span> ;</span><br><span class="line">        <span class="keyword">var</span> InnerClass = Java.use(class_name);</span><br><span class="line">        <span class="keyword">var</span> all_methods = InnerClass.class.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;all_methods.length;i++)&#123;</span><br><span class="line">            <span class="comment">// console.log(all_methods[i]);</span></span><br><span class="line">            <span class="keyword">var</span> method = all_methods[i];</span><br><span class="line">            <span class="keyword">var</span> substring = method.toString().substr(method.toString().indexOf(class_name)+class_name.length+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">var</span> finalMethodString = substring.substr(<span class="number">0</span>,substring.indexOf(<span class="string">"("</span>));</span><br><span class="line">            <span class="built_in">console</span>.log(finalMethodString);</span><br><span class="line">            InnerClass[finalMethodString].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="第五关"><a href="#第五关" class="headerlink" title="第五关"></a>第五关</h4><p><img src="/2022/03/23/frida_hook_java/6_5.png" alt="第五关"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">切换classload</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_5</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 找到class</span></span><br><span class="line">        Java.choose(<span class="string">"com.example.androiddemo.Activity.FridaActivity5"</span>,&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"found instance getDynamicDexCheck :"</span>,instance.getDynamicDexCheck().$className);</span><br><span class="line">            &#125;, <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search complete!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//  切换 ClassLoader</span></span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">loader</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.findClass(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>))&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"Succefully found loader!"</span>,loader);</span><br><span class="line">                        Java.classFactory.loader = loader;  <span class="comment">//  切换 成当前的 ClassLoader</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"found error "</span>+error)</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="string">"enum completed!"</span>&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>).check.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第六关"><a href="#第六关" class="headerlink" title="第六关"></a>第六关</h4><p><img src="/2022/03/23/frida_hook_java/6_6.png" alt="第六关"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">枚举class</span><br></pre></td></tr></table></figure><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_6</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.Frida6.Frida6Class0"</span>).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span> &#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.Frida6.Frida6Class1"</span>).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span> &#125;;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.Frida6.Frida6Class2"</span>).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span> &#125;; </span><br><span class="line">    &#125;)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">level_62</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">name,handle</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(name.toString().indexOf(<span class="string">"com.example.androiddemo.Activity.Frida6.Frida6"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"name"</span>,name);</span><br><span class="line">                    Java.use(name).check.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,onComplete()&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>frida</tag>
      </tags>
  </entry>
  <entry>
    <title>刷机</title>
    <url>/2022/03/27/%E5%88%B7%E6%9C%BA/</url>
    <content><![CDATA[<h3 id="刷机："><a href="#刷机：" class="headerlink" title="刷机："></a>刷机：</h3><p>1.在 <a href="https://developers.google.com/android/images" target="_blank" rel="noopener">谷歌官方工厂镜像网站</a> 下载对应手机型号和版本的安装包</p>
<p><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/1.png" alt="谷歌官方工厂镜像网站"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dl.google.com&#x2F;dl&#x2F;android&#x2F;aosp&#x2F;bullhead-n2g47o-factory-3ff32f55.zip</span><br><span class="line">7z x  bullhead-n2g47o-factory-3ff32f55.zip</span><br></pre></td></tr></table></figure></p>
<ol>
<li>手机最好电量充足,关机, 按住音量下键 和 关机键进入 bootloader, 刷系统</li>
</ol>
<p><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/2.png" alt="bootloader"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd   bullhead-n2g47o-factory-3ff32f55</span><br><span class="line">.&#x2F;flash-all.sh</span><br></pre></td></tr></table></figure><br><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/3.png" alt="成功"></p>
<p>3.手机刷成功后,一些语言,wifi,指纹类的信息设置</p>
<p><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/4.png" alt="bootloader"></p>
<p>4.设置 —&gt; 系统 —&gt; 关于手机 —&gt; 版本号点击7下 —&gt; 返回 —&gt; 开发者选项 —&gt; usb调试</p>
<p><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/5.png" alt="版本号"><br><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/6.png" alt="usb调试"></p>
<ol>
<li><p>将 SuperSU（Magisk 同理） 推入手机, 手机重新进入bootloader,刷<a href="https://twrp.me/" target="_blank" rel="noopener">twrp</a>和搜集版本一样</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push SR5-SuperSU-v2.82-SR5-20171001224502.zip &#x2F;sdcard&#x2F;</span><br><span class="line">adb reboot bootloader</span><br><span class="line">fastboot boot twrp-3.3.0-0-bullhead.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>右滑 —&gt; install —&gt; 点击supersu —&gt; 右滑 —&gt;等待 —&gt; reboot system —&gt; 可以有root 权限<br>(PS: supersu 有时候刷不了，开机卡在Google页面)</p>
</li>
</ol>
<p><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/7.png" alt="usb调试"><br><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/8.png" alt="usb调试"><br><img src="/2022/03/27/%E5%88%B7%E6%9C%BA/9.png" alt="usb调试"></p>
<ol>
<li>wifi 感叹号解决<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">【亲测有效】开机后wifi有感叹号, 时间无法同步解决办法 </span><br><span class="line">在手机的shell里以root用户执行：</span><br><span class="line"># settings put global captive_portal_http_url https:&#x2F;&#x2F;www.google.cn&#x2F;generate_204</span><br><span class="line"># settings put global captive_portal_https_url https:&#x2F;&#x2F;www.google.cn&#x2F;generate_204</span><br><span class="line"># settings put global ntp_server 1.hk.pool.ntp.org</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="pixel-andriod-8-1-0-twrp3-3-Magisk"><a href="#pixel-andriod-8-1-0-twrp3-3-Magisk" class="headerlink" title="pixel+ andriod 8.1.0 + twrp3.3 + Magisk"></a>pixel+ andriod 8.1.0 + twrp3.3 + Magisk</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">刷twrp，Magisk</span><br><span class="line">https:&#x2F;&#x2F;dl.twrp.me&#x2F;sailfish&#x2F;</span><br><span class="line">将 twrp 安装到手机</span><br><span class="line"></span><br><span class="line">1. adb push twrp-pixel-installer-sailfish-3.3.0-0.zip &#x2F;sdcard</span><br><span class="line">2.  将手机设置为fastboot模式，并且按动音量键切换至Recovery模式</span><br><span class="line">3.  fastboot boot twrp-3.3.0-0-sailfish.img</span><br><span class="line">4.  滑动下方的滑块，找到zip包，点击它（遇到坑，在sdcard下找不到zip包，重新push到&#x2F; 目录下）</span><br><span class="line">5.  点击Reboot System完成twrp（Magisk 同理）的刷入</span><br><span class="line"></span><br><span class="line">百度网盘环境</span><br><span class="line">链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Jjm-u7kLUQsWqOgQkcvkYQ </span><br><span class="line">提取码：jl2f</span><br></pre></td></tr></table></figure>
<h4 id="n5x-刷安装10"><a href="#n5x-刷安装10" class="headerlink" title="n5x 刷安装10"></a>n5x 刷安装10</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;blissroms&#x2F;files&#x2F;Q&#x2F;bullhead&#x2F;</span><br><span class="line">下载 857.5 MB </span><br><span class="line">手机 音量向下键 关机键</span><br><span class="line">fastboot flash recovery twrp-3.3.0-0-bullhead.img </span><br><span class="line">adb push Bliss-v12.8-bullhead-OFFICIAL-20200612.zip &#x2F;sdcard&#x2F;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>刷机</tag>
      </tags>
  </entry>
  <entry>
    <title>objection 的基本使用</title>
    <url>/2022/03/23/objection/</url>
    <content><![CDATA[<h3 id="objection"><a href="#objection" class="headerlink" title="objection"></a>objection</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Frida只是提供了各种API供我们调用，在此基础之上可以实现具体的功能，比如禁用证书绑定之类的脚本，就是使用Frida的各种API来组合编写而成。于是有大佬将各种常见、常用的功能整合进一个工具，供我们直接在命令行中使用，这个工具便是objection。</span><br><span class="line">objection功能强大，命令众多，而且不用写一行代码，便可实现诸如内存搜索、类和模块搜索、方法hook打印参数返回值调用栈等常用功能，是一个非常方便的，逆向必备、内存漫游神器</span><br></pre></td></tr></table></figure>
<h4 id="1-开启非标准端口frida"><a href="#1-开启非标准端口frida" class="headerlink" title="1.开启非标准端口frida"></a>1.开启非标准端口frida</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;fs -l 0.0.0.0:8888</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/frida01.png" alt="frida特殊端口"></p>
<h4 id="2-查看objection日志"><a href="#2-查看objection日志" class="headerlink" title="2.查看objection日志"></a>2.查看objection日志</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat .objection&#x2F;objection.log  |grep -i frida</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion02.png" alt="查看objection日志"></p>
<h4 id="3-连接objecion"><a href="#3-连接objecion" class="headerlink" title="3.连接objecion"></a>3.连接objecion</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">objection 和frida 对应版本 需要 看时间</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida&#x2F;releases</span><br><span class="line">https:&#x2F;&#x2F;pypi.org&#x2F;project&#x2F;objection&#x2F;#history</span><br><span class="line"></span><br><span class="line">#正常连接  objection -g com.android.settings explore</span><br><span class="line">#非正常端口连接   objection -N -h 192.168.2.57 -p 8888 -g com.android.settings explore</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion01.png" alt="非正常端口连接"></p>
<h4 id="4-查看内存中加载的库"><a href="#4-查看内存中加载的库" class="headerlink" title="4.查看内存中加载的库"></a>4.查看内存中加载的库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">memory list modules</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion03.png" alt="查看内存中加载的库"></p>
<h4 id="5-查看库的导出函数"><a href="#5-查看库的导出函数" class="headerlink" title="5.查看库的导出函数"></a>5.查看库的导出函数</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正常查看  memory list exports libssl.so</span><br><span class="line">文件导出  memory list exports libart.so --json &#x2F;root&#x2F;libart.json</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion04.png" alt="查看库的导出函数"></p>
<h4 id="6-在内存堆上搜索实例"><a href="#6-在内存堆上搜索实例" class="headerlink" title="6.在内存堆上搜索实例"></a>6.在内存堆上搜索实例</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android heap search instances com.android.settings.DisplaySettings  --fresh</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion05.png" alt="在内存堆上搜索实例"></p>
<h4 id="7-调用实例的方法"><a href="#7-调用实例的方法" class="headerlink" title="7.调用实例的方法"></a>7.调用实例的方法</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android heap execute 0x23ba  getPreferenceScreenResId</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion06.png" alt="调用实例的方法"></p>
<h4 id="8-直接启动activity-直接进入该页面"><a href="#8-直接启动activity-直接进入该页面" class="headerlink" title="8.直接启动activity,直接进入该页面"></a>8.直接启动activity,直接进入该页面</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android intent launch_activity com.android.settings.DisplaySettings</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion07.png" alt="直接启动activity"></p>
<h4 id="9-查看当前可用的activity"><a href="#9-查看当前可用的activity" class="headerlink" title="9.查看当前可用的activity"></a>9.查看当前可用的activity</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking list activities</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion08.png" alt="查看当前可用的activity"></p>
<h4 id="10-列出内存中所有的类"><a href="#10-列出内存中所有的类" class="headerlink" title="10.列出内存中所有的类"></a>10.列出内存中所有的类</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking list classes</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion09.png" alt="列出内存中所有的类"></p>
<h4 id="11-列出类的所有方法"><a href="#11-列出类的所有方法" class="headerlink" title="11.列出类的所有方法"></a>11.列出类的所有方法</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking list class_methods  com.android.settings.DisplaySettings</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion12.png" alt="列出类的所有方法"></p>
<h4 id="12-内存中搜索关键词所有的类"><a href="#12-内存中搜索关键词所有的类" class="headerlink" title="12.内存中搜索关键词所有的类"></a>12.内存中搜索关键词所有的类</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking search classes display</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion10.png" alt="列出内存中所有的类"></p>
<h4 id="13-内存中搜索所有的方法"><a href="#13-内存中搜索所有的方法" class="headerlink" title="13.内存中搜索所有的方法"></a>13.内存中搜索所有的方法</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking search methods display</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion11.png" alt="内存中搜索所有的方法"></p>
<h4 id="14-hook类的所有方法"><a href="#14-hook类的所有方法" class="headerlink" title="14.hook类的所有方法"></a>14.hook类的所有方法</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking watch class android.bluetooth.BluetoothDevice</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion13.png" alt="hook方法的参数、返回值和调用栈"></p>
<h4 id="15-hook方法的参数、返回值和调用栈"><a href="#15-hook方法的参数、返回值和调用栈" class="headerlink" title="15.hook方法的参数、返回值和调用栈"></a>15.hook方法的参数、返回值和调用栈</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking watch class_method android.bluetooth.BluetoothDevice.equals --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.io.File.$init --dump-args</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion14.png" alt="hook方法的参数、返回值和调用栈"></p>
<h4 id="17-插件-Wallbreaker"><a href="#17-插件-Wallbreaker" class="headerlink" title="17.插件 Wallbreaker"></a>17.插件 <a href="https://github.com/hluwa/Wallbreaker" target="_blank" rel="noopener">Wallbreaker</a></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下载 git clone https:&#x2F;&#x2F;github.com&#x2F;hluwa&#x2F;Wallbreaker.git</span><br></pre></td></tr></table></figure>
<h5 id="加载Wallbreaker"><a href="#加载Wallbreaker" class="headerlink" title="加载Wallbreaker"></a>加载Wallbreaker</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">plugin load &#x2F;root&#x2F;Desktop&#x2F;Wallbreaker</span><br></pre></td></tr></table></figure>
<h5 id="wallbreaker-查看类"><a href="#wallbreaker-查看类" class="headerlink" title="wallbreaker 查看类"></a>wallbreaker 查看类</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">plugin wallbreaker classdump --fullname android.bluetooth.BluetoothDevice</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/objecion15.png" alt="wallbreaker 查看类"></p>
<h3 id="实战-腾讯app漏洞第三题"><a href="#实战-腾讯app漏洞第三题" class="headerlink" title="实战: 腾讯app漏洞第三题"></a>实战: 腾讯app漏洞第三题</h3><h4 id="解压ab文件"><a href="#解压ab文件" class="headerlink" title="解压ab文件"></a>解压ab文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ade.jar unpack 1.ab 1.tar </span><br><span class="line">tar xvf 1.tar</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/txs1.png" alt="解压ab文件"></p>
<h4 id="夜神模拟器上-安装-frida-server-x86"><a href="#夜神模拟器上-安装-frida-server-x86" class="headerlink" title="夜神模拟器上 安装 frida-server-x86"></a>夜神模拟器上 安装 frida-server-x86</h4><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">adb push frida-server-12.8.0-android-x86 /data/local/tmp   </span><br><span class="line">adb shell</span><br><span class="line">cd /data/local/tmp</span><br><span class="line">chmod 777 *</span><br><span class="line">./frida-server-12.8.0-android-x86</span><br></pre></td></tr></table></figure>
<h4 id="打开jadx-静态分析"><a href="#打开jadx-静态分析" class="headerlink" title="打开jadx 静态分析"></a>打开jadx 静态分析</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在MainActivity onCreate 调用a方法  a方法总写数据库方法 getWritableDatabase</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/txs2.png" alt="静态分析"><br><img src="/2022/03/23/objection/txs4.png" alt="静态分析"></p>
<h4 id="在-AndroidManifest-xml-查看包名"><a href="#在-AndroidManifest-xml-查看包名" class="headerlink" title="在 AndroidManifest.xml 查看包名"></a>在 AndroidManifest.xml 查看包名</h4><p><img src="/2022/03/23/objection/txs3.png" alt="静态分析"></p>
<h4 id="objection-分析"><a href="#objection-分析" class="headerlink" title="objection 分析"></a>objection 分析</h4><p>打开objection<br><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">objection -g com.example.yaphetshan.tencentwelcome explore</span><br></pre></td></tr></table></figure></p>
<p>静态查看 net.sqlcipher.database.SQLiteOpenHelper类下的方法<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android hooking list class_methods net.sqlcipher.database.SQLiteOpenHelper</span><br></pre></td></tr></table></figure><br><img src="/2022/03/23/objection/txs5.png" alt="静态查看"></p>
<p>动态查看 net.sqlcipher.database.SQLiteOpenHelper类下的方法<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">plugin load &#x2F;root&#x2F;Desktop&#x2F;Wallbreaker</span><br><span class="line">plugin wallbreaker classdump --fullname net.sqlcipher.database.SQLiteOpenHelper</span><br></pre></td></tr></table></figure><br><img src="/2022/03/23/objection/txs6.png" alt="动态查看"></p>
<ol>
<li>hook net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</li>
<li>寻找MainActivity的实例</li>
<li>主动调用MainActivity的实例的a方法<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">android hooking watch class_method net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase --dump-args --dump-backtrace --dump-return </span><br><span class="line">android heap search instances com.example.yaphetshan.tencentwelcome.MainActivity</span><br><span class="line">android heap execute 0x100bda a</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/2022/03/23/objection/txs7.png" alt="主动调用"></p>
<p>DB Browser for SQLite 打开数据库 输入密码 ae56f99</p>
<p><img src="/2022/03/23/objection/txs8.png" alt="打开数据库"><br><img src="/2022/03/23/objection/txs9.png" alt="flag结果"></p>
<hr>
<h5 id="frida-hook"><a href="#frida-hook" class="headerlink" title="frida hook"></a>frida hook</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook 重载 </span></span><br><span class="line">        Java.use(<span class="string">"net.sqlcipher.database.SQLiteOpenHelper"</span>).getWritableDatabase.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.getWritableDatabase(x);</span><br><span class="line">            <span class="comment">// 调用栈</span></span><br><span class="line">            <span class="built_in">console</span>.log(Java.use(<span class="string">"android.util.Log"</span>).getStackTraceString(Java.use(<span class="string">"java.lang.Throwable"</span>).$<span class="keyword">new</span>()));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"xString,result"</span>,x,result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">        Java.use(<span class="string">"net.sqlcipher.database.SQLiteOpenHelper"</span>).getWritableDatabase.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">var</span> result = <span class="keyword">this</span>.getWritableDatabase(x);</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">"xCharSe,result"</span>,x,result);</span><br><span class="line">         <span class="keyword">return</span> result;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;)      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 调用实例，主动调用方法</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"com.example.yaphetshan.tencentwelcome.MainActivity"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"found insttance "</span>,instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"invoke instance.a "</span>,instance.a());</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">"search completed !"</span>)&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/23/objection/txs10.png" alt="frida hook"></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>objection</tag>
      </tags>
  </entry>
  <entry>
    <title>安卓逆向基础之抓包</title>
    <url>/2022/03/13/%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<p>记录一些安卓抓包的工具</p>
<h3 id="一-Charles-抓包"><a href="#一-Charles-抓包" class="headerlink" title="一. Charles 抓包"></a>一. Charles 抓包</h3><h4 id="1-charles-设置"><a href="#1-charles-设置" class="headerlink" title="1.charles 设置"></a>1.charles 设置</h4><p><a href="https://www.charlesproxy.com/download/" target="_blank" rel="noopener">charles安装网址</a></p>
<h5 id="proxy-—-gt-ssl-proxying-settings-—-gt-add-—-gt-设置"><a href="#proxy-—-gt-ssl-proxying-settings-—-gt-add-—-gt-设置" class="headerlink" title="proxy —&gt; ssl proxying settings —&gt; add —&gt; 设置 "></a>proxy —&gt; ssl proxying settings —&gt; add —&gt; 设置<em> </em></h5><p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img.png" alt="ssl设置"></p>
<h5 id="proxy-—-gt-ssl-settings"><a href="#proxy-—-gt-ssl-settings" class="headerlink" title="proxy —&gt; ssl settings"></a>proxy —&gt; ssl settings</h5><p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img_1.png" alt="img_1.png"></p>
<h4 id="2-手机设置"><a href="#2-手机设置" class="headerlink" title="2.手机设置"></a>2.手机设置</h4><h4 id="手机-WiFi设置http代理-在同一局域网"><a href="#手机-WiFi设置http代理-在同一局域网" class="headerlink" title="手机 WiFi设置http代理,在同一局域网"></a>手机 WiFi设置http代理,在同一局域网</h4><p>1.先查看电脑ip<br><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img_2.png" alt="img_2.png"><br>2.wifi —&gt; 修改网络 —&gt; 高级选项 —&gt; 代理 —&gt; 手动<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">现在可以抓到http的包，但是https抓不到</span><br></pre></td></tr></table></figure></p>
<p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img_3.png" alt="img_3.png"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">浏览器输入 chls.pro&#x2F;ssl 下载证书，安装</span><br><span class="line">这样就可以抓到https的包了,百度一下就知道了 </span><br><span class="line">现在抓爱奇艺APP登录的包 抓不到, 那我们继续证书装到系统目录</span><br></pre></td></tr></table></figure></p>
<h4 id="3-将证书安装到系统目录"><a href="#3-将证书安装到系统目录" class="headerlink" title="3.将证书安装到系统目录"></a>3.将证书安装到系统目录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb connect 192.168.31.88</span><br><span class="line">abd shell</span><br><span class="line">su</span><br><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added</span><br><span class="line">mount -o remount,rw &#x2F;system</span><br><span class="line">ls -alist 看哪个是最新安装的</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/charles.png" alt="证书安装到根目录"></p>
<h4 id="4-vpn软件-postern-设置"><a href="#4-vpn软件-postern-设置" class="headerlink" title="4.vpn软件 postern 设置"></a>4.vpn软件 postern 设置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postern  设置配置代理，配置规则</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/p1.png" alt="配置代理"><br><img src="/2022/03/13/%E6%8A%93%E5%8C%85/p2.png" alt="配置规则"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">但是安卓10 系统不能分区  需要用 magisk的MoveCertificates模块，会自动帮我们将证书安装到系统目录 https:&#x2F;&#x2F;blog.csdn.net&#x2F;fjh1997&#x2F;article&#x2F;details&#x2F;106756012</span><br><span class="line">postern 在安卓10上也不好使</span><br></pre></td></tr></table></figure>
<h4 id="另一个vpn软件-SagerNet"><a href="#另一个vpn软件-SagerNet" class="headerlink" title="另一个vpn软件 SagerNet"></a>另一个vpn软件 SagerNet</h4><p><a href="https://blog.seeflower.dev/archives/70/" target="_blank" rel="noopener">SagerNet</a></p>
<h4 id="5-双向验证例子-全国同一信用代码app"><a href="#5-双向验证例子-全国同一信用代码app" class="headerlink" title="5.双向验证例子 全国同一信用代码app"></a>5.双向验证例子 全国同一信用代码app</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将charles证书安装到系统,使用vpn 软件也不能抓到包，这是为什么？</span><br><span class="line">服务器验证客户端证书</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img4.jpg" alt="未抓到"><br>frida下载app 证书 dump_certificate.js<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uuid</span>(<span class="params">len, radix</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chars = <span class="string">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>.split(<span class="string">''</span>);</span><br><span class="line">    <span class="keyword">var</span> uuid = [], i;</span><br><span class="line">    radix = radix || chars.length;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (len) &#123;</span><br><span class="line">      <span class="comment">// Compact form</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) uuid[i] = chars[<span class="number">0</span> | <span class="built_in">Math</span>.random() * radix];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// rfc4122, version 4 form</span></span><br><span class="line">      <span class="keyword">var</span> r;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// rfc4122 requires these characters</span></span><br><span class="line">      uuid[<span class="number">8</span>] = uuid[<span class="number">13</span>] = uuid[<span class="number">18</span>] = uuid[<span class="number">23</span>] = <span class="string">'-'</span>;</span><br><span class="line">      uuid[<span class="number">14</span>] = <span class="string">'4'</span>;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// Fill in random data. At i==19 set the high bits of clock sequence as</span></span><br><span class="line">      <span class="comment">// per rfc4122, sec. 4.1.5</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">36</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!uuid[i]) &#123;</span><br><span class="line">          r = <span class="number">0</span> | <span class="built_in">Math</span>.random() * <span class="number">16</span>;</span><br><span class="line">          uuid[i] = chars[(i == <span class="number">19</span>) ? (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span> : r];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> uuid.join(<span class="string">''</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">storeP12</span>(<span class="params">pri, p7, p12Path, p12Password</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> X509Certificate = Java.use(<span class="string">"java.security.cert.X509Certificate"</span>)</span><br><span class="line">            <span class="keyword">var</span> p7X509 = Java.cast(p7, X509Certificate);</span><br><span class="line">            <span class="keyword">var</span> chain = Java.array(<span class="string">"java.security.cert.X509Certificate"</span>, [p7X509])</span><br><span class="line">            <span class="keyword">var</span> ks = Java.use(<span class="string">"java.security.KeyStore"</span>).getInstance(<span class="string">"PKCS12"</span>, <span class="string">"BC"</span>);</span><br><span class="line">            ks.load(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            ks.setKeyEntry(<span class="string">"client"</span>, pri, Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(p12Password).toCharArray(), chain);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">var</span> out = Java.use(<span class="string">"java.io.FileOutputStream"</span>).$<span class="keyword">new</span>(p12Path);</span><br><span class="line">              ks.store(out, Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(p12Password).toCharArray())</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">"dump success!"</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (exp) &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(exp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//在服务器校验客户端的情形下，帮助dump客户端证书，并保存为p12的格式，证书密码为mmb</span></span><br><span class="line">          Java.use(<span class="string">"java.security.KeyStore$PrivateKeyEntry"</span>).getPrivateKey.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.getPrivateKey()</span><br><span class="line">            <span class="keyword">var</span> packageName = Java.use(<span class="string">"android.app.ActivityThread"</span>).currentApplication().getApplicationContext().getPackageName();</span><br><span class="line">            storeP12(<span class="keyword">this</span>.getPrivateKey(), <span class="keyword">this</span>.getCertificate(), <span class="string">'/sdcard/Download/'</span> + packageName + uuid(<span class="number">10</span>, <span class="number">16</span>) + <span class="string">'.p12'</span>, <span class="string">'mmb'</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">          &#125;</span><br><span class="line">          Java.use(<span class="string">"java.security.KeyStore$PrivateKeyEntry"</span>).getCertificateChain.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.getCertificateChain()</span><br><span class="line">            <span class="keyword">var</span> packageName = Java.use(<span class="string">"android.app.ActivityThread"</span>).currentApplication().getApplicationContext().getPackageName();</span><br><span class="line">            storeP12(<span class="keyword">this</span>.getPrivateKey(), <span class="keyword">this</span>.getCertificate(), <span class="string">'/sdcard/Download/'</span> + packageName + uuid(<span class="number">10</span>, <span class="number">16</span>) + <span class="string">'.p12'</span>, <span class="string">'mmb'</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将手机上的证书pull电脑上，charles安装证书，成功到包</span><br></pre></td></tr></table></figure><br><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img5.jpg" alt="charles 安装证书"><br><img src="/2022/03/13/%E6%8A%93%E5%8C%85/img6.jpg" alt="成功抓到包"></p>
<h3 id="二-mitmproxy"><a href="#二-mitmproxy" class="headerlink" title="二.mitmproxy"></a>二.mitmproxy</h3><p>mitmproxy电脑环境安装 参考崔庆才的博客,<a href="https://cuiqingcai.com/5391.html" target="_blank" rel="noopener">mitmproxy安装</a></p>
<h4 id="逍遥模拟器手机安装证书"><a href="#逍遥模拟器手机安装证书" class="headerlink" title="逍遥模拟器手机安装证书"></a>逍遥模拟器手机安装证书</h4><ol>
<li>电脑运行 mitmdump -p 8999  (端口号随意，不要冲突即可)</li>
<li>查看电脑ip Windows(ipconfig),Liunx(ifconfig)</li>
<li>电脑手机在同一局域网内，手机Wifi设置代理 <img src="/2022/03/13/%E6%8A%93%E5%8C%85/mitmproxy_1.png" alt="设置代理"></li>
<li>在浏览器输入mitm.it，下载证书<img src="/2022/03/13/%E6%8A%93%E5%8C%85/mitmproxy_2.png" alt="下载证书"></li>
<li>安装证书</li>
<li><p>当安装证书还是不行，抓不到数据需要把证书安装到跟目录下<br> <img src="/2022/03/13/%E6%8A%93%E5%8C%85/mitmproxy_0.jpg" alt="参考"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb connect 192.168.31.216</span><br><span class="line">adb shell</span><br><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added</span><br><span class="line">mount -o rw,remount &#x2F;system (安卓7，模拟器是安卓7，安卓8不一样mount -o remount,rw &#x2F;)</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mt.py 将带有aweme/v1/store/product/list链接的数据保存到redis</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">REDIS_HOST = <span class="string">"REDIS_HOST"</span></span><br><span class="line">REDIS_PORT = <span class="number">63791</span></span><br><span class="line">REDIS_ENCODING = <span class="string">'utf-8'</span></span><br><span class="line">red = Redis(host=REDIS_HOST, port=REDIS_PORT, password=<span class="string">"password"</span>, db=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span><span class="params">(flow)</span>:</span></span><br><span class="line">    response_data = flow.response</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'aweme/v1/store/product/list'</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        json_data = json.loads(response_data.text)</span><br><span class="line">        print(json_data)</span><br><span class="line">        red.rpush(<span class="string">'dy:items'</span>, json.dumps(json_data))</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">开启mitmproxy  mitmdump -s mt.py -p 8999 </span><br><span class="line">手机WIFI设置代理 (如果前面做了可以省略)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三-HttpCanary"><a href="#三-HttpCanary" class="headerlink" title="三.HttpCanary"></a>三.HttpCanary</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HttpCanary支持对HTTP协议包的抓取和注入。使用这款App，您将能够非常非常方便的测试Rest API接口请求。同时，HttpCanary提供了各式各样的数据浏览功能，比如Raw视图、Hex视图、Json视图等等。</span><br></pre></td></tr></table></figure>
<h3 id="四-HTTP-Toolkit"><a href="#四-HTTP-Toolkit" class="headerlink" title="四.HTTP Toolkit"></a>四.<a href="https://httptoolkit.tech/" target="_blank" rel="noopener">HTTP Toolkit</a></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、下载它的pc端,window和 mac的都有。</span><br><span class="line">2、下载它的Android App安装</span><br><span class="line">3、PC端上点击 Android device via QR code,出现一个二维码</span><br><span class="line">4、Android 端扫描这个二维码,会自动 开启vpn,然后提示你安装证书,（Android7以上要装magisk的Move Certificates,把证书搞到系统证书区, 重启就生效）</span><br></pre></td></tr></table></figure>
<h3 id="五-r0capture"><a href="#五-r0capture" class="headerlink" title="五.r0capture"></a>五.<a href="https://github.com/r0ysue/r0capture" target="_blank" rel="noopener">r0capture</a></h3><p>使用 抓包爱奇艺</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 r0capture.py -U com.qiyi.video -v &gt;&gt; iqiyi.text</span><br></pre></td></tr></table></figure>
<h3 id="六-混淆型app-抓包-frida-hook-过sslpinning-okhttp-sslunpinning"><a href="#六-混淆型app-抓包-frida-hook-过sslpinning-okhttp-sslunpinning" class="headerlink" title="六.混淆型app 抓包 frida hook 过sslpinning  okhttp-sslunpinning"></a>六.混淆型app 抓包 frida hook 过sslpinning  okhttp-sslunpinning</h3><p>获取okhttp 包名， 替换 loadOkhttpClient 里的类</p>
<p><img src="/2022/03/13/%E6%8A%93%E5%8C%85/1.png" alt="sslunpinning"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> classesNames = <span class="keyword">new</span> <span class="built_in">Array</span>()</span><br><span class="line"><span class="keyword">var</span> OkhttpClientClassName = <span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> CertificatePinnerClassName = <span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> prefix = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initConsole</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> Color = &#123;<span class="attr">RESET</span>: <span class="string">"\x1b[39;49;00m"</span>, <span class="attr">Black</span>: <span class="string">"0;01"</span>, <span class="attr">Blue</span>: <span class="string">"4;01"</span>, <span class="attr">Cyan</span>: <span class="string">"6;01"</span>, <span class="attr">Gray</span>: <span class="string">"7;11"</span>, <span class="string">"Green"</span>: <span class="string">"2;01"</span>, <span class="attr">Purple</span>: <span class="string">"5;01"</span>, <span class="attr">Yellow</span>: <span class="string">"3;01"</span>,  <span class="attr">Red</span>: <span class="string">"1;01"</span>&#125;</span><br><span class="line">    <span class="keyword">var</span> LightColor = &#123;<span class="attr">RESET</span>: <span class="string">"\x1b[39;49;00m"</span>, <span class="attr">Black</span>: <span class="string">"0;11"</span>, <span class="attr">Blue</span>: <span class="string">"4;11"</span>, <span class="attr">Cyan</span>: <span class="string">"6;11"</span>, <span class="attr">Gray</span>: <span class="string">"7;01"</span>, <span class="string">"Green"</span>: <span class="string">"2;11"</span>, <span class="attr">Purple</span>: <span class="string">"5;11"</span>, <span class="attr">Red</span>: <span class="string">"1;11"</span>, <span class="attr">Yellow</span>: <span class="string">"3;11"</span>&#125;</span><br><span class="line">    <span class="keyword">var</span> colorPrefix = <span class="string">'\x1b[3'</span></span><br><span class="line">    <span class="keyword">var</span> colorSuffix = <span class="string">'m'</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(Color).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (c  == <span class="string">"RESET"</span>) </span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">console</span>[c] = <span class="function"><span class="keyword">function</span>(<span class="params">message</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(colorPrefix + Color[c] + colorSuffix + message + Color.RESET)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>[<span class="string">"Light"</span> + c] = <span class="function"><span class="keyword">function</span>(<span class="params">message</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(colorPrefix + LightColor[c] + colorSuffix + message + Color.RESET)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadOkhttpClient</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Java.use(<span class="string">"y.w"</span>)</span><br><span class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="comment">//console.error(e)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadClasses</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">clsName, handle</span>)</span>&#123;</span><br><span class="line">                classesNames.push(clsName)</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.Green(<span class="string">"Search Class Completed!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findOkhttpClass</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Modifier = Java.use(<span class="string">"java.lang.reflect.Modifier"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">isOkhttpClient</span>(<span class="params">clsName</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(clsName.split(<span class="string">'.'</span>).length != <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> cls = Java.use(clsName)</span><br><span class="line">                <span class="keyword">var</span> interfaces = cls.class.getInterfaces()</span><br><span class="line">                <span class="keyword">const</span> count = interfaces.length</span><br><span class="line">                <span class="keyword">if</span>(count &lt; <span class="number">2</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> flag = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)&#123;</span><br><span class="line">                    <span class="keyword">var</span> interface_ = interfaces[i]</span><br><span class="line">                    <span class="keyword">var</span> interface_name = interface_.getName()</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(interface_name.indexOf(<span class="string">"Cloneable"</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        flag = <span class="literal">true</span></span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(interface_name.indexOf(<span class="string">"$"</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!flag) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(cls.class.getDeclaredClasses().length &lt; <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(cls.class.getSuperclass().getName() != <span class="string">'java.lang.Object'</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">isCertificatePinner</span>(<span class="params">clsName,prefix</span>)</span>&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(!clsName.startsWith(prefix))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(clsName.indexOf(<span class="string">"$"</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(clsName.split(<span class="string">'.'</span>).length != <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> cls = Java.use(clsName)</span><br><span class="line">            <span class="keyword">if</span>(cls.class.isInterface())&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(cls.class.getInterfaces().length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">         </span><br><span class="line">            <span class="keyword">if</span>(cls.class.getDeclaredClasses().length &lt; <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(cls.class.getSuperclass().getName() != <span class="string">"java.lang.Object"</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!Modifier.isFinal(cls.class.getModifiers()))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> flag = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">var</span> methods = cls.class.getDeclaredMethods()</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> method = methods[i]</span><br><span class="line">                <span class="keyword">if</span>(method.getParameterCount() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(method.getParameterTypes()[<span class="number">0</span>].getName() == <span class="string">"java.security.cert.Certificate"</span>)&#123;</span><br><span class="line">                    flag = <span class="literal">true</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!flag) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">            flag = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">var</span> fields = cls.class.getDeclaredFields()</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; fields.length; k++)&#123;</span><br><span class="line">                <span class="keyword">var</span> field = fields[k];</span><br><span class="line">                <span class="keyword">if</span>(field.getType().getName() == <span class="string">"java.util.Set"</span>)&#123;</span><br><span class="line">                    flag = <span class="literal">true</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!flag) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classesNames.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(isOkhttpClient(classesNames[i]))&#123;</span><br><span class="line">                OkhttpClientClassName = classesNames[i]</span><br><span class="line">                <span class="keyword">var</span> prefix = classesNames[i].split(<span class="string">'.'</span>)[<span class="number">0</span>]+<span class="string">'.'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classesNames.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(isCertificatePinner(classesNames[i],prefix))&#123;</span><br><span class="line">                CertificatePinnerClassName = classesNames[i]</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> printOut</span><br><span class="line">        <span class="keyword">if</span>(OkhttpClientClassName == <span class="string">""</span> || CertificatePinnerClassName == <span class="string">""</span> || prefix == <span class="string">""</span>)&#123;</span><br><span class="line">            printOut = <span class="built_in">console</span>.Red</span><br><span class="line">            printOut(<span class="string">"Can't find the okhttp class"</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            printOut = <span class="built_in">console</span>.Green</span><br><span class="line">        &#125;</span><br><span class="line">        printOut(<span class="string">"Found Class: "</span>+classesNames.length)</span><br><span class="line">        printOut(<span class="string">"Okhttp's package prefix: "</span>+prefix)</span><br><span class="line">        printOut(<span class="string">"Found the OkhttpClient: "</span>+OkhttpClientClassName)</span><br><span class="line">        printOut(<span class="string">"Found the OkhttpCertificatePinner: "</span>+CertificatePinnerClassName)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Modifier = Java.use(<span class="string">"java.lang.reflect.Modifier"</span>)</span><br><span class="line">        <span class="comment">//TrustAllManager</span></span><br><span class="line">        <span class="keyword">var</span> TrustAllManagerClass = Java.registerClass(&#123;</span><br><span class="line">            name: <span class="string">"TrustAllManager"</span>,</span><br><span class="line">            implements:[Java.use(<span class="string">"javax.net.ssl.X509TrustManager"</span>)],</span><br><span class="line">            methods: &#123;</span><br><span class="line">                checkClientTrusted(chain, authType) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.Cyan(<span class="string">"checkClientTrusted Called!!"</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                checkServerTrusted(chain, authType) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.Cyan(<span class="string">"checkServerTrusted Called!!"</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                getAcceptedIssuers() &#123;</span><br><span class="line">                  <span class="keyword">return</span> [];</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> trustAllManagerHandle = TrustAllManagerClass.$<span class="keyword">new</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sslContext = Java.use(<span class="string">"javax.net.ssl.SSLContext"</span>).getInstance(<span class="string">"TLS"</span>)</span><br><span class="line">        sslContext.init(<span class="literal">null</span>,Java.array(<span class="string">"Ljavax.net.ssl.X509TrustManager;"</span>,[trustAllManagerHandle]),<span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">var</span> sslSocketFactory = sslContext.getSocketFactory()</span><br><span class="line"></span><br><span class="line">        <span class="comment">//HostnameVerify</span></span><br><span class="line">        <span class="keyword">var</span> MyHostnameVerify = Java.registerClass(&#123;</span><br><span class="line">            name: <span class="string">"MyHostnameVerify"</span>,</span><br><span class="line">            implements:[Java.use(<span class="string">"javax.net.ssl.HostnameVerifier"</span>)],</span><br><span class="line">            methods: &#123;</span><br><span class="line">                verify(hostname, session)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(hostname)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> myHostnameVerifyHandle = MyHostnameVerify.$<span class="keyword">new</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> internalOkhttpClientClasses = Java.use(OkhttpClientClassName).class.getDeclaredClasses()</span><br><span class="line">        internalOkhttpClientClasses.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">internalClass</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> methods = internalClass.getDeclaredMethods()</span><br><span class="line">            methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">                 <span class="keyword">if</span>(method.getParameterCount() &lt; <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> firstParameterTypeName = method.getParameterTypes()[<span class="number">0</span>].getName()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(firstParameterTypeName == <span class="string">"javax.net.ssl.SSLSocketFactory"</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> Builder = Java.use(internalClass.getName())</span><br><span class="line">                    <span class="keyword">var</span> sslSocketFacotryMethodName  = method.getName()</span><br><span class="line">                    Builder[sslSocketFacotryMethodName].overloads.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">overload</span>)</span>&#123;</span><br><span class="line">                        overload.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">SSLSocketFactory</span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">arguments</span>[<span class="number">0</span>] = sslSocketFactory</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">this</span>[sslSocketFacotryMethodName].apply(<span class="keyword">this</span>,<span class="built_in">arguments</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">console</span>.Blue(sslSocketFacotryMethodName+<span class="string">"  Hooked!"</span>)</span><br><span class="line">                    &#125;);</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(firstParameterTypeName == <span class="string">"javax.net.ssl.HostnameVerifier"</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> Builder = Java.use(internalClass.getName())</span><br><span class="line">                    <span class="keyword">var</span> hostnameVerifierMethodName = method.getName()</span><br><span class="line">                    Builder[hostnameVerifierMethodName].overloads.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">overload</span>)</span>&#123;</span><br><span class="line">                        overload.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">hostnameVerifier</span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">arguments</span>[<span class="number">0</span>] = myHostnameVerifyHandle</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">this</span>[hostnameVerifierMethodName].apply(<span class="keyword">this</span>,<span class="built_in">arguments</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">console</span>.Yellow(hostnameVerifierMethodName+<span class="string">"  Hooked!"</span>)</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(firstParameterTypeName == CertificatePinnerClassName)&#123;</span><br><span class="line">                    <span class="keyword">var</span> Builder = Java.use(internalClass.getName())</span><br><span class="line">                    <span class="keyword">var</span> certificatePinnerMethodName = method.getName()</span><br><span class="line"></span><br><span class="line">                    Builder[certificatePinnerMethodName].overloads.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">overload</span>)</span>&#123;</span><br><span class="line">                        overload.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">certificatePinner</span>)</span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> Java.retain(<span class="keyword">this</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">console</span>.Purple(certificatePinnerMethodName+<span class="string">"  Hooked!"</span>)</span><br><span class="line">                    &#125;);</span><br><span class="line">                   </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> CertificatePinnerClass = Java.use(CertificatePinnerClassName)</span><br><span class="line">        <span class="keyword">var</span> methods = CertificatePinnerClass.class.getDeclaredMethods()</span><br><span class="line">        methods.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(method.getReturnType().getName() == <span class="string">'void'</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> methodName = method.getName()</span><br><span class="line">                <span class="built_in">console</span>.Cyan(methodName+<span class="string">" Hooked!"</span>)</span><br><span class="line">                CertificatePinnerClass[methodName].overloads.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">overload</span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(overload.returnType.name == <span class="string">'V'</span>)&#123;</span><br><span class="line">                        overload.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">console</span>.Cyan(<span class="string">"certificatePinner check called!"</span>)</span><br><span class="line">                        &#125;   </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve_shell</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Stub = Java.use(<span class="string">"com.stub.StubApp"</span>)</span><br><span class="line">        <span class="keyword">var</span> isFirst = <span class="literal">true</span></span><br><span class="line">        Stub.getOrigApplicationContext.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">context</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(isFirst)&#123;</span><br><span class="line">                isFirst = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">var</span> classloader = context.getClassLoader()</span><br><span class="line">                Java.classFactory.loader = classloader</span><br><span class="line">                resolve_okhttp()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getOrigApplicationContext(context)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve_okhttp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    loadOkhttpClient()</span><br><span class="line">    loadClasses()</span><br><span class="line">    findOkhttpClass()</span><br><span class="line">    hook()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    initConsole()</span><br><span class="line"></span><br><span class="line">    resolve_shell()  <span class="comment">// 脱壳</span></span><br><span class="line">    <span class="comment">//resolve_okhttp()</span></span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<h3 id="七-Android使用Wireshark抓包"><a href="#七-Android使用Wireshark抓包" class="headerlink" title="七.Android使用Wireshark抓包"></a>七.<a href="https://github.com/lasting-yang/frida_bypass_ssl_example/tree/master/Android/android_wireshark_tls" target="_blank" rel="noopener">Android使用Wireshark抓包</a></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注意  需要usb连接手机使用， 不要wifiadb连接使用</span><br><span class="line">安卓手机安装  termux</span><br><span class="line">将下载的tcpdump push 到手机上  adb push tcpdump &#x2F;data&#x2F;local&#x2F;tmp  添加权限  chmod 777 tcpdump</span><br><span class="line">在 termux 安装 netcat:  pkg install netcat-openbsd</span><br><span class="line">进入 nc 安装的位置  cd &#x2F;data&#x2F;data&#x2F;com.termux&#x2F;files&#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">分区 mount -o remount,rw &#x2F;</span><br><span class="line">在复制nc到   cp nc &#x2F;system&#x2F;bin</span><br><span class="line">其他参考文章</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>抓包</tag>
      </tags>
  </entry>
  <entry>
    <title>静态硬patch so binary过反调试</title>
    <url>/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<p>今天这个是看雪一个题目,里面在init() 中有frida反调试,frida开启 过段时间会闪跳</p>
<h4 id="akptool-安装"><a href="#akptool-安装" class="headerlink" title="akptool 安装"></a>akptool 安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mv apktool.txt apktool</span><br><span class="line">chmod 777 apktool*</span><br><span class="line">mv apktool* &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>
<h4 id="jadx-静态分析"><a href="#jadx-静态分析" class="headerlink" title="jadx 静态分析"></a>jadx 静态分析</h4><p>jadx 打开so 是load 加载 native-lib , 7z x app 解压也只有一个64位的 libnative-lib.so</p>
<p><img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/jadx.png" alt="jadx"></p>
<h4 id="ida-分析"><a href="#ida-分析" class="headerlink" title="ida 分析"></a>ida 分析</h4><p>detect_frida_loop 函数对 端口 0.0.0.0 和字符串 ‘REJECT’ 进行了检测</p>
<p><img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/3.png" alt="3"></p>
<p><img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/1.png" alt="1"></p>
<p><img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/2.png" alt="2"></p>
<h4 id="硬patch"><a href="#硬patch" class="headerlink" title="硬patch"></a>硬patch</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.双击 Pseudocode-A 的&quot;0.0.0.0&quot; 跳转到 IDA View-A </span><br><span class="line">2.IDA View-A 选中&quot;0.0.0.0&quot;  切换到 Hex View-1</span><br><span class="line">3.Hex View-1 选中&quot;0.0.0.0&quot;</span><br></pre></td></tr></table></figure>
<p> <img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/4.png" alt="4"><br> <a href="https://www.rapidtables.com/convert/number/hex-to-ascii.html" target="_blank" rel="noopener">hex to ascii</a><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">30  2E 30 2E 30 2E 30 00 对应 0.0.0.0</span><br></pre></td></tr></table></figure><br> <img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/5.png" alt="5"><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">4. 右键如何 edit,将 30 修改为 32</span><br><span class="line">5. 修改完成  右键Apply changes</span><br><span class="line">6. Edit --&gt; Patch program --&gt; Apply Patchs to input file....</span><br><span class="line">修改完成</span><br></pre></td></tr></table></figure><br> <img src="/2022/04/04/%E9%9D%99%E6%80%81%E7%A1%ACpatch%20so%20binary%E8%BF%87%E5%8F%8D%E8%B0%83%E8%AF%95/6.png" alt="6"></p>
<h4 id="重打包"><a href="#重打包" class="headerlink" title="重打包"></a>重打包</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 解包 apktool d 3.apk </span><br><span class="line">2. 替换 libnative-lib.so</span><br><span class="line">3. 打包  apktool b 3 -o .&#x2F;3_mod.apk </span><br><span class="line">4. 签名 java -jar uber-apk-signer-1.2.1.jar -a 3_mod.apk  --allowResign</span><br><span class="line">uber-apk-signer-1.2.1.jar  下载地址：https:&#x2F;&#x2F;github.com&#x2F;patrickfav&#x2F;uber-apk-signer&#x2F;releases&#x2F;tag&#x2F;v1.2.1</span><br><span class="line">手机安装 3_mod-aligned-debugSigned.apk 开启frida 将不会闪跳关闭</span><br></pre></td></tr></table></figure>
<h4 id="frida-hook-过反调试"><a href="#frida-hook-过反调试" class="headerlink" title="frida hook 过反调试"></a>frida hook 过反调试</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookstrcmp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> addr_strcmp = Module.findExportByName(<span class="string">"libc.so"</span>,<span class="string">"strcmp"</span>);</span><br><span class="line">        Interceptor.attach(addr_strcmp, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(ptr(args[<span class="number">1</span>]).readCString().indexOf(<span class="string">"REJECT"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"[*] strcmp ("</span> + ptr(args[<span class="number">0</span>]).readCString() + <span class="string">","</span> + ptr(args[<span class="number">1</span>]).readCString()+<span class="string">")"</span>);</span><br><span class="line">                        <span class="keyword">this</span>.isREJECT = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;,<span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.isREJECT)&#123;</span><br><span class="line">                    retval.replace(<span class="number">0x1</span>);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"the REJECT's result :"</span>,retval);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(hookstrcmp);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>反编译</tag>
      </tags>
  </entry>
</search>
